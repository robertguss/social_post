# Story 4.2: Quick Reschedule Interface

## Status

Draft

## Story

**As a** content creator,
**I want** to quickly reschedule a cloned post with smart time suggestions,
**so that** I can batch schedule recurring content efficiently.

## Acceptance Criteria

1. When cloning a post, the scheduling interface displays "Quick Reschedule" suggestions.
2. Suggestions include: "+1 week", "+1 month", "+3 months" relative to the original post's scheduled time.
3. Clicking a suggestion auto-fills the new scheduled time(s) for the selected platform(s).
4. Users can override suggestions and manually select any date/time.
5. The rescheduled post maintains the same platform selection as the original (Twitter, LinkedIn, or both).
6. A preview shows "Scheduled for {date/time}" before final confirmation.
7. Confirmation creates the scheduled post and displays success feedback.

## Tasks / Subtasks

- [ ] **Task 1: Create time calculation helper utilities** (AC: 2)
  - [ ] Create new file: `lib/timeHelpers.ts` or `utils/dateUtils.ts`
  - [ ] Implement `addWeeks(timestamp: number, weeks: number): number` function
  - [ ] Implement `addMonths(timestamp: number, months: number): number` function
  - [ ] Use native Date APIs for calculations (avoid external libraries if possible)
  - [ ] Handle timezone conversions correctly (preserve local time when adding periods)
  - [ ] Handle edge cases: month boundaries, daylight saving time changes
  - [ ] Export functions for use in components
  - [ ] Add JSDoc comments explaining function behavior

- [ ] **Task 2: Create QuickReschedule component** (AC: 1, 2, 3)
  - [ ] Create new component: `components/features/QuickReschedule.tsx`
  - [ ] Accept props: `originalScheduledTime: number | undefined`, `platform: "twitter" | "linkedin"`, `onSelectTime: (time: number) => void`
  - [ ] Calculate suggested times using helper utilities: +1 week, +1 month, +3 months
  - [ ] Render suggestion buttons in horizontal layout (responsive for mobile)
  - [ ] Style buttons with shadcn/ui Button component (secondary or outline variant)
  - [ ] Display relative time labels: "+1 Week", "+1 Month", "+3 Months"
  - [ ] Show absolute date/time in tooltip or secondary text (e.g., "Feb 15, 2024 at 10:00 AM")
  - [ ] Implement onClick handler that calls `onSelectTime` with calculated timestamp
  - [ ] Handle case when `originalScheduledTime` is undefined (hide component or show disabled state)
  - [ ] Add IconCalendarPlus or similar icon to suggestion buttons
  - [ ] Make component accessible (keyboard navigation, aria-labels)

- [ ] **Task 3: Integrate QuickReschedule into PostScheduler** (AC: 1, 3, 5)
  - [ ] Open `components/features/PostScheduler.tsx`
  - [ ] Import QuickReschedule component
  - [ ] Detect if post is cloned by checking for `clonedFromPostId` field
  - [ ] If cloned, fetch original post to get scheduled times
  - [ ] Display QuickReschedule component for Twitter scheduling if original had `twitterScheduledTime`
  - [ ] Display separate QuickReschedule component for LinkedIn scheduling if original had `linkedInScheduledTime`
  - [ ] Position QuickReschedule components near/above date/time pickers for each platform
  - [ ] Implement `onSelectTime` handler that sets the date/time picker value
  - [ ] Maintain platform selection from original post (if original posted to Twitter only, default Twitter toggle to enabled)
  - [ ] Allow user to toggle platforms on/off regardless of original selection
  - [ ] Ensure QuickReschedule only displays when editing a cloned post (not for new posts)

- [ ] **Task 4: Add scheduling preview display** (AC: 6)
  - [ ] In PostScheduler, add preview text section below schedule inputs
  - [ ] Display "Scheduled for:" label
  - [ ] Show Twitter scheduled time if Twitter toggle is enabled and time is set
  - [ ] Show LinkedIn scheduled time if LinkedIn toggle is enabled and time is set
  - [ ] Format times in user-friendly format: "Monday, Feb 15, 2024 at 10:00 AM" (using date-fns or Intl API)
  - [ ] Show timezone indicator (e.g., "PST" or "Local time")
  - [ ] Update preview reactively as user changes times or toggles
  - [ ] Style preview with subtle background color (info/blue shade)
  - [ ] Add calendar icon to preview section
  - [ ] Handle case when no times are set: display "No schedule set" or hide preview

- [ ] **Task 5: Enhance schedule submission with success feedback** (AC: 7)
  - [ ] In PostScheduler submit handler, ensure post status is set to "scheduled" (not "draft")
  - [ ] After successful mutation, display success toast/notification
  - [ ] Success message: "Post scheduled successfully for {date/time}"
  - [ ] Include platform names in success message (e.g., "for Twitter and LinkedIn")
  - [ ] Redirect user to post history page after scheduling (optional UX improvement)
  - [ ] Clear form fields after successful submission (or keep for batch scheduling)
  - [ ] Handle error cases with error toast (e.g., "Failed to schedule post")
  - [ ] Disable submit button while mutation is in progress (loading state)

- [ ] **Task 6: Handle manual time override** (AC: 4)
  - [ ] Ensure date/time pickers remain fully editable after using QuickReschedule
  - [ ] Test that manually changing time after clicking suggestion works correctly
  - [ ] Verify preview updates when user manually changes time
  - [ ] No special logic needed - native input behavior handles this
  - [ ] Document this behavior in component comments

- [ ] **Task 7: Add unit tests for time calculation helpers** (AC: 2)
  - [ ] Create test file: `lib/timeHelpers.test.ts` or `utils/dateUtils.test.ts`
  - [ ] Test `addWeeks`: verify +1 week calculation is accurate
  - [ ] Test `addMonths`: verify +1 month, +3 months calculations are accurate
  - [ ] Test month boundary edge case (e.g., Jan 31 + 1 month = Feb 28/29)
  - [ ] Test timezone preservation (result maintains same local time)
  - [ ] Test leap year handling (Feb 29 scenarios)
  - [ ] Mock Date.now() for predictable test results

- [ ] **Task 8: Add integration tests for QuickReschedule component** (AC: 1, 2, 3)
  - [ ] Create test file: `components/features/QuickReschedule.test.tsx`
  - [ ] Test component renders suggestion buttons when `originalScheduledTime` is provided
  - [ ] Test component does not render when `originalScheduledTime` is undefined
  - [ ] Test clicking "+1 Week" button calls `onSelectTime` with correct timestamp
  - [ ] Test clicking "+1 Month" button calls `onSelectTime` with correct timestamp
  - [ ] Test clicking "+3 Months" button calls `onSelectTime` with correct timestamp
  - [ ] Test tooltip/secondary text displays correct absolute date
  - [ ] Test component is accessible (keyboard navigation, screen reader support)

- [ ] **Task 9: Add integration tests for PostScheduler with QuickReschedule** (AC: 1, 3, 5, 6)
  - [ ] Extend `components/features/PostScheduler.test.tsx`
  - [ ] Test QuickReschedule displays when post is cloned (has `clonedFromPostId`)
  - [ ] Test QuickReschedule does NOT display for new posts (no `clonedFromPostId`)
  - [ ] Test clicking suggestion auto-fills date/time picker
  - [ ] Test platform toggles match original post's platform selection
  - [ ] Test scheduling preview updates when time is selected
  - [ ] Test preview displays correct formatted date/time
  - [ ] Test manual time override after using suggestion works
  - [ ] Test successful submission shows success feedback

## Dev Notes

### Architecture Context

This story builds on Story 4.1 (Clone Past Post) by adding intelligent time suggestions to streamline the rescheduling workflow. Instead of manually selecting dates each time they repost content, users can quickly choose common intervals (+1 week, +1 month, +3 months) relative to the original post time.

**Key Design Decisions:**

- Time suggestions are relative to the **original post's scheduled time** (not current time), enabling predictable recurring schedules
- Suggestions are displayed inline near the date/time pickers for discoverability
- Users retain full control to override suggestions with manual time selection
- Preview display provides confirmation before scheduling to prevent errors
- Platform selection from original post is preserved as default but remains user-editable

[Source: docs/prd/6-epic-details.md:280-293]

### Data Models

This story uses existing data from the `posts` table (no schema changes required):

**Relevant fields from posts table:**
- `clonedFromPostId: v.optional(v.id("posts"))` - Indicates post is a clone (from Story 4.1)
- `twitterScheduledTime: v.optional(v.number())` - Timestamp for Twitter post scheduling
- `linkedInScheduledTime: v.optional(v.number())` - Timestamp for LinkedIn post scheduling

To fetch original post's scheduled times:
```typescript
const originalPost = await ctx.db.get(clonedPost.clonedFromPostId);
const originalTwitterTime = originalPost.twitterScheduledTime;
const originalLinkedInTime = originalPost.linkedInScheduledTime;
```

[Source: convex/schema.ts:7-21, docs/stories/4.1.clone-past-post-functionality.md]

### Component Architecture

**New Component:**

- **QuickReschedule.tsx**: Reusable time suggestion widget
  - Location: `components/features/QuickReschedule.tsx`
  - Props: `originalScheduledTime`, `platform`, `onSelectTime`
  - Renders 3 suggestion buttons (+1 week, +1 month, +3 months)
  - Calculates timestamps using helper utilities
  - Calls parent callback when suggestion is selected

**Modified Component:**

- **PostScheduler.tsx**: Post creation/scheduling form
  - Location: `components/features/PostScheduler.tsx`
  - Integrates QuickReschedule components for Twitter and LinkedIn scheduling sections
  - Fetches original post data when `clonedFromPostId` exists
  - Displays scheduling preview with formatted dates
  - Enhanced success feedback after scheduling

**New Utility Module:**

- **timeHelpers.ts** or **dateUtils.ts**: Time calculation utilities
  - Location: `lib/timeHelpers.ts` or `utils/dateUtils.ts`
  - Functions: `addWeeks(timestamp, weeks)`, `addMonths(timestamp, months)`
  - Pure functions with no side effects (easy to test)

[Source: docs/architecture/frontend-architecture.md#component-architecture]

### Previous Story Insights

**From Story 4.1 (Clone Past Post Functionality):**

- Cloned posts have `clonedFromPostId` field linking to original post
- Cloned posts start with status "draft" and cleared scheduled times
- PostScheduler already supports loading draft posts via URL parameter
- Need to fetch original post to access its scheduled times for suggestions

[Source: docs/stories/4.1.clone-past-post-functionality.md]

**From Story 2.3 (Dual Platform Post Creation Form):**

- PostScheduler has separate date/time pickers for Twitter and LinkedIn
- Platform toggles allow users to enable/disable posting to each platform
- Date/time pickers use standard HTML input type="datetime-local" or date picker library
- Form state managed with React useState hooks

[Source: docs/stories/2.3.dual-platform-post-creation-form.md]

**From Story 1.4 (Post Creation Form - X Focus):**

- PostScheduler uses local timezone for date/time selection
- Timestamps stored as Unix milliseconds (number) in Convex
- Form validation ensures scheduled times are in the future

[Source: docs/stories/1.4.post-creation-form-x-focus.md]

### Tech Stack & Libraries

- **Frontend**: Next.js 15.5.4, React 19, shadcn/ui components, Tabler icons
- **Date Handling**: Native JavaScript Date API or date-fns library (if already in dependencies)
  - Check `package.json` for existing date libraries
  - Prefer native APIs to avoid adding dependencies
  - Use `date-fns` if already available for formatting (e.g., `formatDistanceToNow`, `format`)
- **State Management**: React `useState` hooks for form state
- **Backend**: Convex queries to fetch original post data

[Source: docs/architecture/tech-stack.md]

### Date/Time Calculation Details

**Adding weeks:**
```typescript
function addWeeks(timestamp: number, weeks: number): number {
  const date = new Date(timestamp);
  date.setDate(date.getDate() + weeks * 7);
  return date.getTime();
}
```

**Adding months (handles month boundaries):**
```typescript
function addMonths(timestamp: number, months: number): number {
  const date = new Date(timestamp);
  date.setMonth(date.getMonth() + months);
  return date.getTime();
}
```

**Important considerations:**
- JavaScript Date automatically handles month overflow (e.g., Jan 31 + 1 month = Feb 28/29)
- Timezone is preserved (same local time after adding period)
- Use `getTime()` to return Unix timestamp in milliseconds (Convex format)

### Testing

**Test Locations:**
- Utility tests: `lib/timeHelpers.test.ts` or `utils/dateUtils.test.ts`
- Component tests: `components/features/QuickReschedule.test.tsx`
- Integration tests: Extend `components/features/PostScheduler.test.tsx`

**Testing Framework:**
- Jest for unit tests
- React Testing Library for component tests
- Mock Date.now() for predictable time-based tests

**Key Test Cases:**
1. Unit: Time calculation functions return correct timestamps
2. Unit: Month boundary edge cases handled correctly (Jan 31 + 1 month)
3. Component: QuickReschedule renders suggestions and handles clicks
4. Integration: Clicking suggestion auto-fills date/time picker in PostScheduler
5. Integration: Preview displays correct formatted date/time
6. Integration: Manual override after using suggestion works correctly

[Source: docs/architecture/testing-strategy.md]

### UX Flow

**User Journey for Quick Rescheduling:**

1. User clicks "Clone" button on a published post in Post History (Story 4.1)
2. PostScheduler opens with cloned draft post pre-filled
3. User sees "Quick Reschedule" suggestions above date/time pickers
4. Suggestions show "+1 Week", "+1 Month", "+3 Months" with absolute dates in tooltips
5. User clicks "+1 Week" - date/time picker auto-fills with calculated time
6. Preview section shows "Scheduled for: Monday, Feb 15, 2024 at 10:00 AM"
7. User can still manually adjust time if desired
8. User clicks "Schedule Post" button
9. Success toast: "Post scheduled successfully for Twitter and LinkedIn"
10. User redirected to Post History (optional) or form cleared for next post

### Accessibility Considerations

- QuickReschedule buttons must have clear aria-labels (e.g., "Schedule 1 week from original post time")
- Keyboard navigation: Tab through suggestion buttons, Enter to select
- Tooltips with absolute dates must be accessible via keyboard (focus state)
- Preview section should have role="status" for screen reader announcements

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-01 | 1.0 | Initial story draft created | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

_(To be filled by dev agent during implementation)_

### Debug Log References

_(To be filled by dev agent during implementation)_

### Completion Notes List

_(To be filled by dev agent during implementation)_

### File List

_(To be filled by dev agent during implementation)_

## QA Results

_(To be filled by QA agent after implementation)_
