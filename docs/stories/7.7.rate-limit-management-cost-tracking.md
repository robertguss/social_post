# Story 7.7: Rate Limit Management & Cost Tracking

## Status

Draft

## Story

**As an** engineer and user,
**I want** to manage Gemini API rate limits and track costs,
**so that** the application remains within budget and users aren't blocked by rate limits.

## Acceptance Criteria

1. The application tracks the number of Gemini API calls made per day/month.
2. A `ai_usage_logs` table stores: `clerkUserId`, `timestamp`, `feature` (tone/expand/hashtags), `tokensUsed`, `cost` (estimated).
3. If the daily rate limit is approaching (e.g., 90% of quota), users receive a warning message when invoking AI features.
4. Admin users can view total API usage and estimated costs in a dashboard or logs.
5. The application respects Gemini API rate limits and implements exponential backoff if rate-limited.
6. Users can view their personal AI usage stats in the settings/preferences page (optional).
7. Documentation includes cost estimates per feature (e.g., "~$0.001 per tone adjustment") to set user expectations.

## Tasks / Subtasks

- [ ] **Task 1: Create ai_usage_logs table** (AC: 2)
- [ ] **Task 2: Implement usage tracking on each AI call** (AC: 1, 2)
- [ ] **Task 3: Add rate limit warning system** (AC: 3)
- [ ] **Task 4: Create admin usage dashboard** (AC: 4)
- [ ] **Task 5: Implement rate limit handling** (AC: 5)
- [ ] **Task 6: Add user usage stats page** (AC: 6)
- [ ] **Task 7: Document cost estimates** (AC: 7)
- [ ] **Task 8: Write tests for rate limit management** (AC: 1-5)

## Dev Notes

Final story in Epic 7, ensures AI usage is monitored and cost-effective.

### Data Models

**ai_usage_logs table:**
- `clerkUserId`: string
- `timestamp`: number
- `feature`: "tone" | "expand" | "hashtags"
- `tokensUsed`: number
- `cost`: number (estimated in USD)

**Index:** `by_user`: ["clerkUserId"]

## Change Log

| Date       | Version | Description                          | Author     |
| :--------- | :------ | :----------------------------------- | :--------- |
| 2025-11-01 | 1.0     | Initial draft created from Epic 7.7. | Sarah (PO) |

## Dev Agent Record

To be populated by Dev Agent during implementation.

## QA Results

To be populated by QA Agent after implementation review.
