# Story 1.4: Post Creation Form (X Focus & Core Fields)

## Status

Done

## Story

**As a** content creator,
**I want** a form to enter my content and schedule it for X/Twitter,
**so that** I can batch create my content.

## Acceptance Criteria

1. A multi-line text input field is provided for post content.
2. A character counter for X/Twitter (280 max) displays with visual warnings (260 char limit).
3. A field for a separate URL is provided for threading.
4. A date/time selector is provided for manual time selection (local timezone only).
5. On submission, a `posts` record is created in the database with status `Scheduled`.

## Tasks / Subtasks

- [x] **Task 1: Install and Configure shadcn/ui** (AC: 1, 2, 3, 4)
  - [x] Install shadcn/ui CLI and configure for the project
  - [x] Add required UI primitives: `textarea`, `input`, `button`, `label`, `card`
  - [x] Add calendar and time picker components for date/time selection
  - [x] Verify Tailwind CSS integration with shadcn/ui components
  - [x] Test basic component rendering and styling

- [x] **Task 2: Create Post Form Component Structure** (AC: 1, 2, 3, 4)
  - [x] Create `components/features/PostScheduler.tsx` component file
  - [x] Set up React state for form fields: `content`, `url`, `scheduledTime`
  - [x] Implement local UI state management using `useState` hooks
  - [x] Create form layout structure with shadcn/ui Card component
  - [x] Add form accessibility attributes (labels, ARIA attributes)

- [x] **Task 3: Implement Multi-Line Text Input with Character Counter** (AC: 1, 2)
  - [x] Add shadcn/ui Textarea component for post content input
  - [x] Implement character counting logic (real-time update on input change)
  - [x] Display character count: `{currentLength}/280`
  - [x] Add visual warning styles when character count reaches 260 (e.g., yellow/orange text)
  - [x] Add error state and disable submit when character count exceeds 280
  - [x] Test character counter with various input scenarios (empty, near limit, over limit)

- [x] **Task 4: Implement URL Input Field** (AC: 3)
  - [x] Add shadcn/ui Input component for URL field
  - [x] Add label: "URL (optional - will be posted as reply)"
  - [x] Implement basic URL validation (optional but recommended)
  - [x] Add helper text explaining URL will be threaded as reply on X

- [x] **Task 5: Implement Date/Time Selector** (AC: 4)
  - [x] Add shadcn/ui Calendar and TimePicker components (or date-time picker)
  - [x] Configure date/time picker to use local timezone
  - [x] Set minimum date/time to current time (prevent scheduling in the past)
  - [x] Display selected date/time in readable format
  - [x] Handle timezone conversion to UTC timestamp for storage

- [x] **Task 6: Create Convex Mutation for Post Creation** (AC: 5)
  - [x] Create `createPost` mutation in `convex/posts.ts`
  - [x] Define mutation args with validators: `content` (v.string()), `url` (v.optional(v.string())), `scheduledTime` (v.number())
  - [x] Verify user authentication using `ctx.auth.getUserIdentity()`
  - [x] Insert new post record into `posts` table with status `Scheduled`
  - [x] Set `twitterContent` and `twitterScheduledTime` fields from form data
  - [x] Return the created post ID to the client
  - [x] Add error handling for validation failures and database errors

- [x] **Task 7: Integrate Form with Convex Mutation** (AC: 5)
  - [x] Import `useMutation` hook from Convex in PostScheduler component
  - [x] Connect form submit handler to `createPost` mutation
  - [x] Convert local date/time to UTC timestamp before sending to mutation
  - [x] Handle mutation success: clear form and show success message/toast
  - [x] Handle mutation errors: display error message to user
  - [x] Add loading state during mutation execution (disable submit button)

- [x] **Task 8: Create Post Scheduler Page/Route** (AC: 1, 2, 3, 4, 5)
  - [x] Create `app/schedule/page.tsx` route file
  - [x] Import and render PostScheduler component
  - [x] Add route protection using Clerk middleware
  - [x] Add page title and basic layout structure
  - [x] Test navigation to `/schedule` route

- [x] **Task 9: Unit Testing for Character Counter Logic** (AC: 2)
  - [x] Create test file: `__tests__/components/PostScheduler.test.tsx`
  - [x] Write unit test: character counter updates correctly on input change
  - [x] Write unit test: warning state activates at 260 characters
  - [x] Write unit test: error state activates at 280+ characters
  - [x] Write unit test: submit button is disabled when character limit exceeded
  - [x] Ensure all tests pass

- [x] **Task 10: Integration Testing for Post Creation Flow** (AC: 5)
  - [x] Create test file: `__tests__/convex/posts.test.ts`
  - [x] Write integration test: `createPost` mutation successfully inserts record
  - [x] Write integration test: mutation verifies user authentication
  - [x] Write integration test: mutation validates required fields
  - [x] Write integration test: post status is set to `Scheduled`
  - [x] Write integration test: timestamp conversion works correctly
  - [x] Mock Convex context and database operations
  - [x] Ensure all tests pass

## Dev Notes

### Architecture Context

This story implements the core Post Creation Form, which is the **primary workspace** for the content creator to batch-create scheduled posts for X/Twitter. The form must be simple, fast, and mobile-responsive, prioritizing utility and efficiency.

[Source: docs/prd/3-user-interface-design-goals.md#overall-ux-vision]

### Previous Story Insights

From Story 1.3:

- The `posts` table schema is fully defined in `convex/schema.ts`
- Convex mutations follow the pattern of verifying user auth using `ctx.auth.getUserIdentity()`
- All data must be scoped to the authenticated user's `clerkUserId`
- Testing infrastructure is set up with Jest (configured in Story 1.1)

[Source: docs/stories/1.3.secure-token-encryption-storage.md#dev-agent-record]

### Tech Stack Details

**Frontend:**

- **Framework**: Next.js 15.5.4 with App Router
- **UI Component Library**: shadcn/ui (to be installed in this story)
- **Styling**: Tailwind CSS ^4
- **Language**: TypeScript ^5

**Backend:**

- **Database/Functions**: Convex ^1.28.0
- **API Style**: Convex Mutations for data writes

**State Management:**

- **Local UI State**: React `useState` hooks for form inputs, character counter, validation states
- **Global Data State**: Convex `useMutation` hook for post creation

[Source: docs/architecture/tech-stack.md]
[Source: docs/architecture/frontend-architecture.md#state-management-architecture]

### Data Models

#### `posts` Table

This table stores content and scheduling details. The form will create new records in this table.

**Key Fields for This Story:**

- `clerkUserId`: string (Clerk user ID - automatically set from authenticated user)
- `status`: string (set to "Scheduled" on form submission)
- `twitterContent`: string (the post content from the textarea field)
- `linkedInContent`: string (not used in this story - can be null or empty)
- `twitterScheduledTime`: number (UTC timestamp from the date/time picker)
- `linkedInScheduledTime`: number (not used in this story - can be null)
- `url`: string (optional - the URL to be posted as a reply/thread)

**Index:** `by_user` on `["clerkUserId"]` - enables fast lookup of all posts for the authenticated user

[Source: docs/architecture/data-models.md]

### Frontend Architecture Details

#### Component Architecture

**Component Type: Core Feature**

The PostScheduler component should be placed in `components/features/PostScheduler.tsx` as a complex workflow component.

**Component Responsibilities:**

1. Render form UI using shadcn/ui primitives
2. Manage local form state (content, url, scheduledTime)
3. Implement character counting logic
4. Handle form validation
5. Call Convex mutation on form submission
6. Display success/error feedback

[Source: docs/architecture/frontend-architecture.md#component-architecture]

#### Routing

The form should be accessible at `/schedule` route.

**Implementation:**

- Create `app/schedule/page.tsx`
- Route should be protected (Clerk middleware handles this automatically)

[Source: docs/architecture/frontend-architecture.md#routing-architecture]

### UI Component Library: shadcn/ui

**Installation Steps:**

1. Install shadcn/ui CLI: `npx shadcn@latest init`
2. Add required components:
   - `npx shadcn@latest add textarea`
   - `npx shadcn@latest add input`
   - `npx shadcn@latest add button`
   - `npx shadcn@latest add label`
   - `npx shadcn@latest add card`
   - `npx shadcn@latest add calendar` (for date picker)

**Component Usage:**

- shadcn/ui components are installed to `components/ui/` directory
- Import from `@/components/ui/{component-name}`
- Components are fully customizable and use Tailwind CSS classes

[Source: docs/architecture/tech-stack.md]

### Character Counting Requirements

**Twitter/X Limits:**

- Maximum: 280 characters
- Warning threshold: 260 characters (visual warning - yellow/orange text)
- Error threshold: 280+ characters (disable submit button, show error)

**Implementation:**

- Use `content.length` for character counting
- Update counter on every input change (real-time)
- Display format: `{currentLength}/280`
- Apply conditional styling based on thresholds

[Source: docs/prd/2-requirements.md#functional - FR3]

### Date/Time Selection Requirements

**Timezone Handling:**

- User selects time in **local timezone**
- Convert to UTC timestamp before storing in database
- Use JavaScript `Date` object for timezone conversion
- Store as Unix timestamp (number) in `twitterScheduledTime` field

**Validation:**

- Minimum selectable time: current time (prevent past scheduling)
- No maximum time constraint

[Source: docs/prd/2-requirements.md#functional - FR5]

### Convex Mutation Pattern

**File Location:** `convex/posts.ts` (new file to be created)

**Mutation Structure:**

```typescript
import { mutation } from "./_generated/server";
import { v } from "convex/values";

export const createPost = mutation({
  args: {
    content: v.string(),
    url: v.optional(v.string()),
    scheduledTime: v.number(),
  },
  returns: v.id("posts"),
  handler: async (ctx, args) => {
    // 1. Verify user authentication
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Not authenticated");
    const clerkUserId = identity.subject;

    // 2. Insert post record
    const postId = await ctx.db.insert("posts", {
      clerkUserId,
      status: "Scheduled",
      twitterContent: args.content,
      linkedInContent: "", // Not used in this story
      twitterScheduledTime: args.scheduledTime,
      linkedInScheduledTime: null, // Not used in this story
      url: args.url || "",
    });

    return postId;
  },
});
```

[Source: CLAUDE.md#convex-function-patterns]

### File Locations

Based on project repository structure:

**New Files to Create:**

- `components/features/PostScheduler.tsx` - Main form component
- `components/ui/*` - shadcn/ui primitive components (auto-generated)
- `app/schedule/page.tsx` - Post creation route
- `convex/posts.ts` - Convex mutations for post management
- `__tests__/components/PostScheduler.test.tsx` - Component tests
- `__tests__/convex/posts.test.ts` - Mutation integration tests

**Files to Modify:**

- None (this is a new feature)

[Source: docs/architecture/high-level-architecture.md#repository-structure]

### Project Structure Notes

The repository structure aligns with the architecture specification. The new PostScheduler component will follow the feature-first pattern by being placed in `components/features/`.

No structural conflicts identified.

## Testing

### Testing Standards

**Test Levels Required:**

1. **Unit Tests:**
   - Framework: Jest (already configured from Story 1.1)
   - Focus Areas:
     - Character counting logic (real-time updates, threshold detection)
     - Form validation (required fields, character limits)
     - Timestamp conversion (local timezone to UTC)
   - Location: `__tests__/components/PostScheduler.test.tsx`

2. **Integration Tests:**
   - Framework: Jest with Convex testing utilities
   - Focus Areas:
     - `createPost` mutation successfully inserts record with correct fields
     - Mutation verifies user authentication
     - Post status is set to "Scheduled"
     - User data scoping (clerkUserId is set correctly)
     - Error handling for validation failures
   - Location: `__tests__/convex/posts.test.ts`

[Source: docs/architecture/testing-strategy.md]

### Error Handling for This Story

**Client/UI Layer:**

- Display clear error messages for validation failures (character limit, empty fields)
- Show user-friendly error messages for mutation failures
- Use loading states to prevent duplicate submissions
- Handle network errors gracefully

**Convex Mutation Layer:**

- Throw clear errors if user is not authenticated
- Validate all required fields (content, scheduledTime)
- Return descriptive error messages for client display
- Log errors for debugging (without exposing sensitive data)

[Source: docs/architecture/testing-strategy.md#error-handling-strategy]

### Test Coverage Requirements

- All character counting logic must have unit tests
- Form validation logic must be tested (empty content, character limits)
- Timestamp conversion must be tested to ensure correct UTC storage
- Integration tests must verify post record is created with correct status
- Error scenarios must be tested (unauthenticated user, validation failures)

## Change Log

| Date       | Version | Description                    | Author           |
| :--------- | :------ | :----------------------------- | :--------------- |
| 2025-10-30 | 1.0     | Initial story creation (Draft) | Scrum Master Bob |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

- Fixed TypeScript circular reference issues in convex/connections.ts and convex/encryption.ts by:
  - Adding explicit return type annotations to handler functions
  - Removing `returns` field from function definitions to avoid circular type inference
  - Separated Node.js queries/mutations into convex/encryptionHelpers.ts (non-Node module)
- Fixed build error where `getConnectionInternal` was defined in a "use node" module (only actions can use Node.js)
- Updated app/api/auth/twitter/callback/route.ts to use `convex.action()` instead of `convex.mutation()` for saveConnection

### Completion Notes List

- ‚úÖ All 10 tasks completed successfully
- ‚úÖ shadcn/ui installed and configured (textarea, input, label, card, calendar, popover components)
- ‚úÖ PostScheduler component created with all required features:
  - Real-time character counter with visual warnings (260 yellow, 280+ red)
  - URL input field with helper text
  - DateTimePicker component created for scheduling (local timezone with validation)
- ‚úÖ Convex `createPost` mutation created with full validation:
  - User authentication verification
  - Content validation (required, max 280 chars)
  - Scheduled time validation (must be in future)
  - Returns post ID
- ‚úÖ Form integrated with Convex mutation using `useMutation` hook
- ‚úÖ `/schedule` route created at app/schedule/page.tsx
- ‚úÖ All tests passing (59 total):
  - 9 unit tests for character counter logic
  - 9 integration tests for post creation mutation
  - All existing tests still pass
- ‚úÖ Build successful with no errors or warnings
- üìù Note: Publishing action scheduling will be implemented in a future story (TODO comment added in posts.ts)

### File List

**New Files Created:**

- components/features/PostScheduler.tsx - Main form component with character counter, URL field, and date/time picker
- components/ui/datetime-picker.tsx - Custom DateTimePicker component combining Calendar and time input
- components/ui/textarea.tsx - shadcn/ui textarea component (auto-generated)
- components/ui/input.tsx - shadcn/ui input component (auto-generated)
- components/ui/label.tsx - shadcn/ui label component (auto-generated)
- components/ui/card.tsx - shadcn/ui card component (auto-generated)
- components/ui/calendar.tsx - shadcn/ui calendar component (auto-generated)
- components/ui/popover.tsx - shadcn/ui popover component (auto-generated)
- app/schedule/page.tsx - Schedule post page route
- convex/posts.ts - Convex mutations for post management (createPost mutation)
- convex/encryptionHelpers.ts - Non-Node.js query/mutation helpers split from encryption.ts
- **tests**/components/PostScheduler.test.tsx - Unit tests for character counter and form validation
- **tests**/convex/posts.test.ts - Integration tests for createPost mutation
- **mocks**/convex-react.ts - Jest mock for Convex React hooks
- **mocks**/convex-api.ts - Jest mock for Convex API

**Modified Files:**

- jest.config.ts - Updated moduleNameMapper to handle Convex imports in tests
- convex/connections.ts - Fixed TypeScript issues (removed "use node", added explicit return types)
- convex/encryption.ts - Fixed TypeScript issues (removed queries/mutations, added explicit return types)
- components/features/ConnectionManager.tsx - Fixed async/await issue in generateCodeChallenge function
- app/api/auth/twitter/callback/route.ts - Changed saveConnection from mutation to action call

## QA Results

To be completed by QA Agent
