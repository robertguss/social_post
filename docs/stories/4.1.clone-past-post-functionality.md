# Story 4.1: Clone Past Post Functionality

## Status

Ready

## Story

**As a** content creator,
**I want** to clone a successful past post,
**so that** I can quickly repurpose content without retyping.

## Acceptance Criteria

1. Published and failed posts in the post history display a "Clone" button/icon.
2. Clicking "Clone" opens the post creation form pre-filled with the original post's content (Twitter and/or LinkedIn), URL, and other metadata.
3. Scheduled times are cleared (not cloned) - user must set new times.
4. The cloned post creates a new record in the `posts` table with status "Draft".
5. A "Cloned from" reference is stored in the new post record linking to the original post ID.
6. Users can edit all fields before scheduling the cloned post.
7. The original post remains unchanged (no modification to source post).

## Tasks / Subtasks

- [ ] **Task 1: Update posts schema to support cloning** (AC: 5)
  - [ ] Add `clonedFromPostId` field to posts table schema as `v.optional(v.id("posts"))`
  - [ ] Deploy schema update to Convex development environment
  - [ ] Verify schema migration doesn't affect existing posts

- [ ] **Task 2: Create clonePost mutation in convex/posts.ts** (AC: 2, 3, 4, 5, 7)
  - [ ] Import mutation builder and validators from Convex
  - [ ] Define `clonePost` mutation with args: `postId: v.id("posts")`
  - [ ] Verify user authentication using `ctx.auth.getUserIdentity()`
  - [ ] Fetch original post by ID using `ctx.db.get(args.postId)`
  - [ ] Verify original post exists and belongs to authenticated user (security check)
  - [ ] Create new post object with cloned content fields: `twitterContent`, `linkedInContent`, `url`
  - [ ] Set new post status to "draft"
  - [ ] Set `clonedFromPostId` to original post's `_id`
  - [ ] Clear scheduling fields: `twitterScheduledTime`, `linkedInScheduledTime`, `twitterSchedulerId`, `linkedInSchedulerId`
  - [ ] Clear publishing fields: `twitterPostId`, `linkedInPostId`, `errorMessage`, `retryCount`
  - [ ] Insert new post into database using `ctx.db.insert("posts", newPostData)`
  - [ ] Return new post ID to caller
  - [ ] Add error handling for post not found or unauthorized access

- [ ] **Task 3: Add Clone button to PostHistory component** (AC: 1)
  - [ ] Open `components/features/PostHistory.tsx`
  - [ ] Add shadcn/ui Button component import (if not already imported)
  - [ ] Import appropriate icon (e.g., IconCopy from Tabler icons)
  - [ ] Add Clone button to each post card/row in the history
  - [ ] Display Clone button only for posts with status "published" or "failed" (conditional rendering)
  - [ ] Hide Clone button for posts with status "draft", "scheduled", or "publishing"
  - [ ] Add onClick handler that calls clone function with post ID
  - [ ] Style button appropriately (secondary variant, with icon)
  - [ ] Add aria-label for accessibility: "Clone this post"
  - [ ] Position button alongside other post actions (Edit, Delete)

- [ ] **Task 4: Implement clone handler in PostHistory** (AC: 2, 6)
  - [ ] Import `useMutation` from Convex React
  - [ ] Import `api` from convex/\_generated/api
  - [ ] Create `clonePost` mutation hook: `const clonePost = useMutation(api.posts.clonePost)`
  - [ ] Create `handleClone` async function that accepts `postId` parameter
  - [ ] Call `clonePost({ postId })` mutation and await result (new post ID)
  - [ ] Add loading state during mutation execution (disable button, show spinner)
  - [ ] On success, redirect user to PostScheduler with new draft post pre-loaded
  - [ ] Use Next.js router to navigate: `router.push(/schedule?postId=${newPostId})`
  - [ ] On error, display error toast/notification to user
  - [ ] Add try-catch error handling around mutation call

- [ ] **Task 5: Update PostScheduler to support loading draft posts** (AC: 2, 3, 6)
  - [ ] Open `components/features/PostScheduler.tsx`
  - [ ] Check if component already supports draft loading (from Story 2.5 or earlier)
  - [ ] If not implemented: Add URL parameter reading using Next.js `useSearchParams`
  - [ ] If `postId` param exists, fetch post using Convex query
  - [ ] Create `useEffect` to pre-populate form fields when draft post loads
  - [ ] Set Twitter content field to `post.twitterContent` if present
  - [ ] Set LinkedIn content field to `post.linkedInContent` if present
  - [ ] Set URL field to `post.url` if present
  - [ ] Ensure scheduled time fields remain empty (AC: 3)
  - [ ] Enable platform toggles based on which content exists (if twitterContent exists, enable Twitter toggle)
  - [ ] Allow user to edit all pre-filled fields before scheduling

- [ ] **Task 6: Add visual indicator for cloned posts** (AC: 5)
  - [ ] In PostScheduler, check if loaded post has `clonedFromPostId` field
  - [ ] If `clonedFromPostId` exists, display informational badge/alert at top of form
  - [ ] Message text: "This is a draft cloned from a previous post"
  - [ ] Include link to view original post (optional enhancement)
  - [ ] Use subtle styling (info color, not warning or error)
  - [ ] Make badge dismissible (user can close it)

- [ ] **Task 7: Test clonePost mutation** (AC: 4, 5, 7)
  - [ ] Create test file: `convex/posts.test.ts` (or add to existing test file)
  - [ ] Mock Convex database context and auth
  - [ ] Test clonePost creates new post with status "draft"
  - [ ] Test clonedFromPostId is set correctly to original post ID
  - [ ] Test content fields are copied correctly (twitterContent, linkedInContent, url)
  - [ ] Test scheduling fields are cleared (all undefined)
  - [ ] Test publishing fields are cleared (postId, errorMessage, retryCount all undefined)
  - [ ] Test unauthorized access is rejected (user tries to clone another user's post)
  - [ ] Test post not found error handling
  - [ ] Test original post remains unchanged after cloning

- [ ] **Task 8: Test Clone button UI and interaction** (AC: 1, 2, 6)
  - [ ] Create test file for PostHistory component: `components/features/PostHistory.test.tsx`
  - [ ] Test Clone button displays for published posts
  - [ ] Test Clone button displays for failed posts
  - [ ] Test Clone button does NOT display for draft, scheduled, or publishing posts
  - [ ] Test clicking Clone button calls clonePost mutation with correct post ID
  - [ ] Test loading state displays during mutation execution
  - [ ] Test successful clone redirects to PostScheduler with new draft post ID
  - [ ] Test error handling displays error message to user
  - [ ] Test Clone button has correct aria-label for accessibility

- [ ] **Task 9: Test PostScheduler draft loading** (AC: 2, 3, 6)
  - [ ] Create test file for PostScheduler: `components/features/PostScheduler.test.tsx` (or add to existing)
  - [ ] Test PostScheduler loads draft post when postId URL param exists
  - [ ] Test form fields are pre-populated with draft post content
  - [ ] Test scheduled time fields remain empty
  - [ ] Test user can edit pre-filled content
  - [ ] Test visual indicator displays for cloned posts
  - [ ] Test PostScheduler works normally without postId param (new post creation)

## Dev Notes

### Architecture Context

This story introduces the first feature in Epic 4 (Content Recycling & Re-queue System), enabling users to clone successful past posts for repurposing. This is a foundational capability that will be extended in Story 4.2 (Quick Reschedule) and Story 4.3 (Recurring Queues).

**Key Design Decisions:**

- Clone creates a new "draft" post rather than "scheduled" to force user review before publishing
- Scheduled times are intentionally cleared to prevent accidental duplicate posting at same time
- Original post ID is tracked via `clonedFromPostId` for audit trail and future analytics
- Only published/failed posts can be cloned (not drafts or scheduled posts that user can already edit)
- Clone operation redirects to PostScheduler for immediate editing rather than silent background cloning

[Source: docs/prd/6-epic-details.md:266-279]

### Data Models

**posts table schema** (existing):

```typescript
posts: defineTable({
  clerkUserId: v.string(),
  status: v.string(), // "draft" | "scheduled" | "publishing" | "published" | "failed"
  twitterContent: v.optional(v.string()),
  linkedInContent: v.optional(v.string()),
  twitterScheduledTime: v.optional(v.number()),
  linkedInScheduledTime: v.optional(v.number()),
  twitterSchedulerId: v.optional(v.id("_scheduled_functions")),
  linkedInSchedulerId: v.optional(v.id("_scheduled_functions")),
  url: v.optional(v.string()),
  errorMessage: v.optional(v.string()),
  retryCount: v.optional(v.number()),
  twitterPostId: v.optional(v.string()),
  linkedInPostId: v.optional(v.string()),
}).index("by_user", ["clerkUserId"]);
```

**New field to add:**

- `clonedFromPostId: v.optional(v.id("posts"))` - References original post ID if this post was cloned

[Source: convex/schema.ts:7-21]

### Component Architecture

**Modified Components:**

- **PostHistory.tsx**: Post history/management page
  - Location: `components/features/PostHistory.tsx`
  - Add Clone button to post cards (displayed for published/failed posts only)
  - Implement clone handler using `useMutation`
  - Handle loading states and error feedback
  - Navigate to PostScheduler after successful clone

- **PostScheduler.tsx**: Post creation/scheduling form
  - Location: `components/features/PostScheduler.tsx`
  - Already supports draft loading (likely from Story 2.5 post editing)
  - May need enhancement to read `postId` URL param if not already implemented
  - Pre-populate form fields from loaded draft post
  - Display visual indicator when post is cloned (if `clonedFromPostId` exists)

[Source: docs/architecture/frontend-architecture.md#component-architecture]

### Backend Implementation

**New Convex Mutation:**

- **clonePost**: Creates duplicate post with draft status
  - Location: `convex/posts.ts`
  - Input: `postId: v.id("posts")`
  - Returns: `v.id("posts")` (new post ID)
  - Security: Verify authenticated user owns original post before cloning
  - Logic: Copy content fields, clear scheduling/publishing fields, set status to "draft"
  - Reference implementation pattern from existing mutations in `convex/posts.ts`

[Source: docs/architecture/tech-stack.md, docs/prd/6-epic-details.md:266-279]

### Previous Story Insights

**From Story 2.5 (Post Management - Edit/Delete/Reschedule):**

- PostHistory component displays posts with action buttons (Edit, Delete)
- Edit functionality likely already implements draft loading in PostScheduler
- Rescheduling logic handles updating scheduled Convex actions
- Post status determines which actions are available (edit only for "scheduled" posts)
- May be able to reuse draft loading logic from Edit feature

[Source: docs/stories/2.5.post-management-edit-delete-reschedule.md]

**From Story 1.6 (Post Status & Basic History):**

- PostHistory component displays posts filtered by status and platform
- Post cards show status badges: Scheduled, Publishing, Published, Failed
- Status-based filtering and date range filtering already implemented
- Need to ensure Clone button placement doesn't conflict with existing UI

[Source: docs/stories/1.6.post-status-basic-history.md]

### Tech Stack & Libraries

- **Frontend**: Next.js 15.5.4, React 19, shadcn/ui components, Tabler icons
- **Backend**: Convex (mutations, queries)
- **State Management**: Convex `useQuery` and `useMutation` hooks
- **Routing**: Next.js App Router with URL parameters (`useSearchParams`)
- **Form State**: React `useState` hooks for local form state

[Source: docs/architecture/tech-stack.md]

### Security Considerations

- **Authorization**: Clone mutation MUST verify authenticated user owns the original post before allowing clone
- **Data Scoping**: All cloned posts MUST inherit `clerkUserId` from authenticated user (not from original post)
- **Input Validation**: Validate `postId` parameter exists and is valid Convex ID

[Source: docs/architecture/security.md, CLAUDE.md - Authentication Flow]

### Testing

**Test Locations:**

- Backend tests: Create or extend `convex/posts.test.ts`
- Frontend tests: Create `components/features/PostHistory.test.tsx` and extend `components/features/PostScheduler.test.tsx`

**Testing Framework:**

- Use Jest for unit and integration tests
- Mock Convex database and auth contexts for backend tests
- Use React Testing Library for component tests

**Key Test Cases:**

1. Unit: clonePost mutation copies content correctly and clears scheduling fields
2. Unit: clonePost mutation enforces authorization (rejects cross-user cloning)
3. Integration: Clone button appears only for published/failed posts
4. Integration: Clicking Clone button creates draft and redirects to PostScheduler
5. Integration: PostScheduler pre-populates form from cloned draft
6. Integration: Original post remains unchanged after cloning

[Source: docs/architecture/testing-strategy.md]

## Change Log

| Date       | Version | Description                 | Author             |
| ---------- | ------- | --------------------------- | ------------------ |
| 2025-11-01 | 1.0     | Initial story draft created | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

_(To be filled by dev agent during implementation)_

### Debug Log References

_(To be filled by dev agent during implementation)_

### Completion Notes List

_(To be filled by dev agent during implementation)_

### File List

_(To be filled by dev agent during implementation)_

## QA Results

_(To be filled by QA agent after implementation)_
