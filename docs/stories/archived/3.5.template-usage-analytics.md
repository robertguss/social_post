# Story 3.5: Template Usage Analytics

## Status

Done

## Story

**As a** content creator,
**I want** to see which templates I use most frequently,
**so that** I can optimize my template library.

## Acceptance Criteria

1. The Templates page displays templates sorted by usage count (most used first) by default.
2. Each template card shows the `usageCount` and `lastUsedAt` timestamp.
3. A sort dropdown allows sorting by: "Most Used", "Recently Used", "Name (A-Z)", "Date Created".
4. Templates that have never been used display "Never used" instead of a timestamp.
5. The usage count increments each time a template is inserted into the post composer.
6. Analytics are displayed in a clear, visually accessible format (e.g., badge for count, relative time for last used).

## Tasks / Subtasks

- [x] **Task 1: Add sort dropdown UI to TemplateLibrary** (AC: 3)
  - [x] Import shadcn/ui Select component
  - [x] Add sort state management using `useState`
  - [x] Create sort dropdown with options: "Most Used", "Recently Used", "Name (A-Z)", "Date Created"
  - [x] Position dropdown in Templates page header (near search bar)
  - [x] Use IconArrowsSort or similar Tabler icon for visual indicator
  - [x] Make dropdown accessible (keyboard navigation, proper ARIA labels)
  - [x] Default sort option: "Most Used"

- [x] **Task 2: Implement sort logic in TemplateLibrary** (AC: 1, 3)
  - [x] Modify `filteredTemplates` useMemo to apply sorting after filtering
  - [x] Implement "Most Used" sort: `sort((a, b) => b.usageCount - a.usageCount)`
  - [x] Implement "Recently Used" sort: `sort((a, b) => (b.lastUsedAt || 0) - (a.lastUsedAt || 0))`
  - [x] Implement "Name (A-Z)" sort: `sort((a, b) => a.name.localeCompare(b.name))` (already exists, reuse)
  - [x] Implement "Date Created" sort: `sort((a, b) => a._creationTime - b._creationTime)`
  - [x] Ensure sorting works correctly with search and tag filters (sorting applied after filtering)
  - [x] Test edge cases: templates with same usageCount, templates never used (no lastUsedAt)

- [x] **Task 3: Display usageCount in TemplateCard** (AC: 2, 6)
  - [x] Modify `TemplateCard.tsx` to accept and display `usageCount` prop
  - [x] Add usage count badge (shadcn/ui Badge component)
  - [x] Position badge prominently (e.g., top-right corner or near template name)
  - [x] Style badge with distinct color (e.g., blue/gray) to differentiate from tag badges
  - [x] Use IconChartBar or IconTrendingUp icon next to count for visual clarity
  - [x] Display count format: "Used X times" or just "X" with icon

- [x] **Task 4: Display lastUsedAt timestamp in TemplateCard** (AC: 2, 4, 6)
  - [x] Modify `TemplateCard.tsx` to accept and display `lastUsedAt` prop
  - [x] Add timestamp display below template content preview or near usage count
  - [x] Format timestamp as relative time (e.g., "2 hours ago", "3 days ago")
  - [x] Use `date-fns` library for relative time formatting (`formatDistanceToNow`)
  - [x] Handle `lastUsedAt === undefined`: display "Never used" text
  - [x] Style "Never used" with muted color (gray) for less emphasis
  - [x] Include IconClock or similar icon next to timestamp
  - [x] Ensure timestamp updates reactively when template is used

- [x] **Task 5: Update TemplateCard tests for analytics display** (AC: 2, 4, 6)
  - [x] Test usageCount displays correctly (e.g., "Used 5 times")
  - [x] Test lastUsedAt displays as relative time (e.g., "2 days ago")
  - [x] Test "Never used" displays when lastUsedAt is undefined
  - [x] Test badge styling and positioning
  - [x] Mock `formatDistanceToNow` for predictable test results

- [x] **Task 6: Update TemplateLibrary tests for sorting** (AC: 1, 3)
  - [x] Test default sort is "Most Used" (templates with highest usageCount appear first)
  - [x] Test sort dropdown changes sorting order correctly
  - [x] Test "Recently Used" sort (templates with most recent lastUsedAt first)
  - [x] Test "Name (A-Z)" sort (alphabetical order)
  - [x] Test "Date Created" sort (oldest templates first)
  - [x] Test sorting works correctly with search and tag filters applied
  - [x] Test edge cases: all templates have usageCount 0, all templates never used

- [x] **Task 7: Verify incrementTemplateUsage integration** (AC: 5)
  - [x] Review Story 3.4 implementation to confirm `incrementTemplateUsage` is called on template insertion
  - [x] Test that usageCount increments correctly when template is inserted in PostScheduler
  - [x] Test that lastUsedAt updates to current timestamp on insertion
  - [x] Test that TemplateLibrary reactively updates to show new analytics after insertion
  - [x] Verify analytics update is fire-and-forget (doesn't block template insertion)

## Dev Notes

### Architecture Context

This story completes Epic 3 (Post Templates & Snippet Library) by adding usage analytics to the Templates page. It enables users to track which templates are most valuable and make data-driven decisions about their template library organization.

**Key Design Decisions:**

- Sort dropdown provides multiple views of template library (usage-based, time-based, alphabetical)
- Default sort is "Most Used" to highlight most valuable templates first
- Usage analytics (count + timestamp) are displayed directly on each template card for quick reference
- Relative timestamps ("2 days ago") are more user-friendly than absolute dates
- Analytics data is already tracked by `incrementTemplateUsage` mutation (Story 3.4), no backend changes needed

[Source: docs/prd/6-epic-details.md:241-253]

### Previous Story Insights

**From Story 3.2 (Templates UI):**

- TemplateLibrary component is implemented in `components/features/TemplateLibrary.tsx`
- Templates are displayed using TemplateCard components in a grid layout
- Search and tag filtering already implemented using `useMemo` with reactive updates
- Current sort is alphabetical by name (A-Z) in `getTemplates` query

[Source: components/features/TemplateLibrary.tsx:1-200]

**From Story 3.3 (Tag & Search System):**

- Search and tag filtering use `useMemo` to derive `filteredTemplates` from `templates`
- Filtering logic is client-side (no server round-trips)
- Search filters by template name or content (case-insensitive)
- Tag filtering uses AND logic (templates must have all selected tags)

[Source: docs/stories/3.3.tag-search-system-templates.md:84-94]

**From Story 3.4 (Insert Templates into Post Composer):**

- `incrementTemplateUsage` mutation updates `lastUsedAt` (timestamp) and `usageCount` (increment)
- Mutation is called after template insertion in PostScheduler
- Usage tracking is fire-and-forget (errors don't block template insertion)
- Templates schema includes `usageCount` (number) and `lastUsedAt` (optional number)

[Source: docs/stories/3.4.insert-templates-into-post-composer.md:170-192, convex/templates.ts:193-228]

### Component Architecture

**Modified Component:**

- **TemplateLibrary.tsx**: Main templates page component
  - Location: `components/features/TemplateLibrary.tsx`
  - Add sort dropdown UI (shadcn/ui Select)
  - Add sort state management (`sortBy` state)
  - Modify `filteredTemplates` useMemo to apply sorting after filtering
  - Pass `usageCount` and `lastUsedAt` props to TemplateCard

- **TemplateCard.tsx**: Individual template display card
  - Location: `components/features/TemplateCard.tsx`
  - Add `usageCount` and `lastUsedAt` to component props
  - Display usage count badge (shadcn/ui Badge)
  - Display relative timestamp using `date-fns` library
  - Display "Never used" text when `lastUsedAt` is undefined

[Source: docs/architecture/frontend-architecture.md#component-architecture]

### Tech Stack & Libraries

**Frontend:**

- shadcn/ui Select (for sort dropdown)
- shadcn/ui Badge (for usage count display)
- Tabler Icons: IconArrowsSort, IconChartBar, IconClock, IconTrendingUp
- date-fns library: `formatDistanceToNow` for relative time formatting
- React hooks: useState (for sort state), useMemo (for sorting logic)

**Backend:**

- No backend changes required (analytics already tracked in Story 3.4)

[Source: docs/architecture/tech-stack.md]

### Data Models

**templates table** (existing, no schema changes):

```typescript
{
  clerkUserId: string,
  name: string,
  content: string,
  tags: string[],
  usageCount: number,          // Display in badge on TemplateCard
  lastUsedAt?: number,          // Display as relative time, or "Never used"
  _id: Id<"templates">,
  _creationTime: number         // Used for "Date Created" sort
}
```

**Index:** `by_user` on `["clerkUserId"]`

[Source: convex/schema.ts:33-40]

### Sorting Logic Implementation

**Sort Options:**

1. **Most Used** (default):

   ```typescript
   templates.sort((a, b) => b.usageCount - a.usageCount);
   ```

2. **Recently Used**:

   ```typescript
   templates.sort((a, b) => (b.lastUsedAt || 0) - (a.lastUsedAt || 0));
   ```

   - Templates without `lastUsedAt` (never used) will sort to the bottom

3. **Name (A-Z)** (existing logic):

   ```typescript
   templates.sort((a, b) => a.name.localeCompare(b.name));
   ```

4. **Date Created**:

   ```typescript
   templates.sort((a, b) => a._creationTime - b._creationTime);
   ```

   - Oldest templates first (ascending order)

**Integration with Filtering:**

```typescript
const filteredTemplates = useMemo(() => {
  if (!templates) return [];

  let filtered = templates;

  // Apply tag filtering (AND logic)
  if (selectedTags.length > 0) {
    filtered = filtered.filter((template) =>
      selectedTags.every((tag) => template.tags.includes(tag)),
    );
  }

  // Apply search filtering
  if (searchQuery.trim()) {
    const query = searchQuery.toLowerCase();
    filtered = filtered.filter(
      (template) =>
        template.name.toLowerCase().includes(query) ||
        template.content.toLowerCase().includes(query),
    );
  }

  // Apply sorting (AFTER filtering)
  switch (sortBy) {
    case "mostUsed":
      filtered.sort((a, b) => b.usageCount - a.usageCount);
      break;
    case "recentlyUsed":
      filtered.sort((a, b) => (b.lastUsedAt || 0) - (a.lastUsedAt || 0));
      break;
    case "name":
      filtered.sort((a, b) => a.name.localeCompare(b.name));
      break;
    case "dateCreated":
      filtered.sort((a, b) => a._creationTime - b._creationTime);
      break;
  }

  return filtered;
}, [templates, searchQuery, selectedTags, sortBy]);
```

### Relative Timestamp Formatting

Use `date-fns` library for user-friendly relative time display:

```typescript
import { formatDistanceToNow } from "date-fns";

// In TemplateCard component
const formatLastUsed = (lastUsedAt?: number) => {
  if (!lastUsedAt) return "Never used";

  return formatDistanceToNow(new Date(lastUsedAt), { addSuffix: true });
  // Examples: "2 hours ago", "3 days ago", "about 1 month ago"
};
```

### UI/UX Patterns

**Sort Dropdown Placement:**

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Templates                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [+ Create Template]                                 â”‚
â”‚                                                     â”‚
â”‚ [Search icon] Search...     Sort by: [Most Used â–¼] â”‚
â”‚ Tags: [#hashtags] [#closing] [#twitter]            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Template 1              [Used 12 times] ğŸ“Š      â”‚ â”‚
â”‚ â”‚ Content preview...      Last used 2 hours ago â°â”‚ â”‚
â”‚ â”‚ #hashtags #twitter      [Edit] [Delete]         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Template 2              [Used 5 times] ğŸ“Š       â”‚ â”‚
â”‚ â”‚ Content preview...      Last used 3 days ago â° â”‚ â”‚
â”‚ â”‚ #closing                [Edit] [Delete]         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Template Card Layout (with Analytics):**

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Template Name    [Used 12 times] ğŸ“Š  â”‚
â”‚                                       â”‚
â”‚ Content preview text goes here...     â”‚
â”‚                                       â”‚
â”‚ #tag1 #tag2                           â”‚
â”‚ â° Last used 2 hours ago              â”‚
â”‚                                       â”‚
â”‚ [Edit]  [Delete]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Never Used Template:**

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Unused Template  [Used 0 times] ğŸ“Š   â”‚
â”‚                                       â”‚
â”‚ Content preview text goes here...     â”‚
â”‚                                       â”‚
â”‚ #tag1                                 â”‚
â”‚ â° Never used                         â”‚
â”‚                                       â”‚
â”‚ [Edit]  [Delete]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### File Locations

**Modified Files:**

- `components/features/TemplateLibrary.tsx` - Add sort dropdown and sorting logic
- `components/features/TemplateCard.tsx` - Add usage analytics display (count + timestamp)

**Test Files (Modified):**

- `components/features/__tests__/TemplateLibrary.test.tsx` - Add sorting tests
- `components/features/__tests__/TemplateCard.test.tsx` - Add analytics display tests

**New Dependencies:**

- `date-fns` library (add to package.json if not already present)

[Source: docs/architecture/high-level-architecture.md#repository-structure]

### Security & Authentication

No security changes required for this story. All template queries remain scoped to authenticated user via `clerkUserId` in existing `getTemplates` query.

[Source: docs/architecture/security.md]

### Performance Considerations

**Client-Side Sorting:**

- Sorting is applied in `useMemo` after filtering, minimizing re-computation
- All sorting logic is O(n log n) with standard JavaScript sort
- No performance concerns for typical template libraries (dozens to hundreds of templates)

**Reactive Updates:**

- Convex reactive queries automatically update `templates` when `incrementTemplateUsage` mutation runs
- `filteredTemplates` useMemo automatically re-computes with new sort order
- No manual cache invalidation or refresh logic needed

**Date-fns Bundle Size:**

- Use `formatDistanceToNow` function directly (tree-shakeable)
- No need to import entire date-fns library

### Testing

#### Testing Standards

- **Test Level**: Unit tests for React components (TemplateLibrary, TemplateCard)
- **Tools**: Jest (or equivalent), React Testing Library
- **File Location**: Tests colocated in `components/features/__tests__/`
- **Critical Focus**: Sorting logic, analytics display, relative time formatting, edge cases (never used templates)

[Source: docs/architecture/testing-strategy.md]

#### Test Coverage Requirements

1. **TemplateLibrary Sorting:**
   - Default sort is "Most Used" (templates sorted by usageCount descending)
   - Sort dropdown changes sorting order correctly
   - "Recently Used" sort works (templates sorted by lastUsedAt descending)
   - "Name (A-Z)" sort works (alphabetical order)
   - "Date Created" sort works (oldest templates first)
   - Sorting works correctly with search and tag filters applied
   - Edge case: All templates have usageCount 0 (sort by name as fallback)
   - Edge case: All templates have no lastUsedAt (sort by \_creationTime as fallback)

2. **TemplateCard Analytics Display:**
   - Usage count displays correctly (e.g., "Used 5 times" or "5")
   - lastUsedAt displays as relative time (e.g., "2 days ago")
   - "Never used" displays when lastUsedAt is undefined
   - Badge styling is distinct from tag badges
   - Icons display next to count and timestamp
   - Mock `formatDistanceToNow` for predictable test results

3. **Integration with incrementTemplateUsage:**
   - usageCount increments correctly when template is inserted in PostScheduler
   - lastUsedAt updates to current timestamp on insertion
   - TemplateLibrary reactively updates to show new analytics after insertion
   - Analytics update is fire-and-forget (doesn't block template insertion)

4. **Edge Cases:**
   - Templates with same usageCount (sort by name as secondary sort)
   - Templates with same lastUsedAt (sort by name as secondary sort)
   - Templates never used (no lastUsedAt) sort to bottom in "Recently Used"
   - Templates with usageCount 0 but have lastUsedAt (possible if manually set)

## Change Log

| Date       | Version | Description                    | Author       |
| ---------- | ------- | ------------------------------ | ------------ |
| 2025-11-01 | 1.0     | Initial story document created | Scrum Master |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

None

### Completion Notes List

- All tasks and subtasks completed successfully
- Added sort dropdown with 4 sorting options (Most Used, Recently Used, Name A-Z, Date Created)
- Implemented sorting logic that works seamlessly with existing search and tag filters
- Added analytics display to TemplateCard (usage count badge and relative timestamp)
- All tests passing (33 tests for TemplateCard and TemplateLibrary)
- No linting errors in modified files
- Verified incrementTemplateUsage integration from Story 3.4
- Templates now default to "Most Used" sort, highlighting most valuable templates first

### File List

**Modified**:

- components/features/TemplateLibrary.tsx - Added sort dropdown UI and sorting logic
- components/features/TemplateCard.tsx - Added analytics display (usageCount badge and lastUsedAt timestamp)
- components/features/**tests**/TemplateLibrary.test.tsx - Added sorting tests and fixed existing tests for new default sort
- components/features/**tests**/TemplateCard.test.tsx - Added analytics display tests

**Dependencies**:

- date-fns (already installed) - Used for relative time formatting

## QA Results

_To be populated by QA agent after implementation._
