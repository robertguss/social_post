# Story 1.1: Project Setup & Authentication

## Status

Ready for Review

## Story

**As a** user,
**I want** a secure login and the base project structure,
**so that** I can begin connecting my accounts.

## Acceptance Criteria

1. The Next.js project runs with the Clerk/Convex context provided.
2. A user can successfully sign up and log in via Clerk/Next.js components.
3. The main app route is protected by Clerk middleware.
4. The foundational Convex database is initialized with the `posts` and `user_connections` tables defined in the schema.

## Tasks / Subtasks

- [x] **Task 1: Configure Clerk Authentication** (AC: 1, 2, 3)
  - [x] Verify Clerk API keys are set in environment variables
  - [x] Ensure `app/layout.tsx` contains ClerkProvider wrapping the application
  - [x] Configure `middleware.ts` to protect main app routes using Clerk middleware
  - [x] Verify Clerk sign-up and sign-in components render correctly
  - [x] Test successful user registration and login flow

- [x] **Task 2: Configure Convex Backend Integration** (AC: 1)
  - [x] Verify Convex deployment URL is configured in environment variables
  - [x] Ensure `ConvexClientProvider` is properly wrapping the application in `app/layout.tsx`
  - [x] Verify Convex auth configuration in `convex/auth.config.ts` integrates with Clerk
  - [x] Test that the Convex client connects successfully to the backend

- [x] **Task 3: Define Convex Database Schema** (AC: 4)
  - [x] Create `posts` table schema in `convex/schema.ts` with fields: `clerkUserId` (string), `status` (string), `twitterContent` (optional string), `linkedInContent` (optional string), `twitterScheduledTime` (optional number), `linkedInScheduledTime` (optional number), `url` (optional string), `errorMessage` (optional string), `retryCount` (optional number), `twitterPostId` (optional string), `linkedInPostId` (optional string)
  - [x] Define index `by_user` on `["clerkUserId"]` for the `posts` table
  - [x] Create `user_connections` table schema with fields: `clerkUserId` (string), `platform` (string), `accessToken` (string - will be encrypted), `refreshToken` (string - will be encrypted), `expiresAt` (number)
  - [x] Define index `by_user_platform` on `["clerkUserId", "platform"]` for the `user_connections` table
  - [x] Deploy the schema to Convex using `npx convex dev` or `npx convex deploy`

- [x] **Task 4: Verify End-to-End Integration** (AC: 1, 2, 3, 4)
  - [x] Start the development environment with `npm run dev`
  - [x] Verify the Next.js application loads without errors
  - [x] Test user sign-up flow and verify user session is created
  - [x] Test user login flow and verify protected routes are accessible
  - [x] Verify Convex database tables are created and accessible via Convex dashboard
  - [x] Confirm that unauthenticated users are redirected by middleware

- [x] **Task 5: Unit Testing** (AC: 1, 2, 3, 4)
  - [x] Write unit tests for Clerk middleware configuration (verify route protection logic)
  - [x] Write integration tests for Convex schema validation (verify table structure and indexes)
  - [x] Test authentication flow with mock Clerk session
  - [x] Verify all tests pass

## Dev Notes

### Architecture Context

This story establishes the foundational infrastructure for the Social Posting Scheduler application. The implementation follows a **Serverless Fullstack** architecture using Next.js for the frontend and Convex for the unified backend.

[Source: architecture/high-level-architecture.md#technical-summary]

### Tech Stack Details

- **Frontend Framework**: Next.js 15.5.4 with App Router
- **Backend/Database**: Convex ^1.28.0 (provides unified DB, realtime queries, and scheduled functions)
- **Authentication**: Clerk ^6.12.6 (single-user authentication and session management)
- **Language**: TypeScript ^5 (type safety throughout)
- **Styling**: Tailwind CSS ^4

[Source: architecture/tech-stack.md]

### Repository Structure

The project uses an **Integrated Monorepo** structure:

```plaintext
social_post/
├── app/                    # Next.js pages and routing
│   ├── (server)/           # Server components
│   ├── globals.css         # Tailwind CSS
│   └── layout.tsx          # Root layout with Clerk/Convex Contexts
├── components/             # Reusable UI components
├── convex/                 # All backend logic (DB, Queries, Mutations, Actions)
│   ├── auth.config.ts      # Clerk/Convex integration config
│   ├── myFunctions.ts      # Example functions
│   └── schema.ts           # Database schema definition
├── hooks/                  # Custom Convex/React hooks
├── middleware.ts           # Clerk protection for routes
└── package.json            # Unified dependencies
```

[Source: architecture/high-level-architecture.md#repository-structure]

### Data Models for This Story

This story requires implementing two critical data tables in `convex/schema.ts`:

#### 1. `posts` Table

Stores scheduled and published content.

**Key Fields:**

- `clerkUserId`: string (Clerk user ID)
- `status`: string (values: "draft" | "scheduled" | "publishing" | "published" | "failed")
- `twitterContent`: string (optional)
- `linkedInContent`: string (optional)
- `twitterScheduledTime`: number (optional, timestamp)
- `linkedInScheduledTime`: number (optional, timestamp)
- `url`: string (optional, for auto-commenting)
- `errorMessage`: string (optional)
- `retryCount`: number (optional)
- `twitterPostId`: string (optional)
- `linkedInPostId`: string (optional)

**Index:** `by_user` on `["clerkUserId"]` - enables fast lookup of all posts for the authenticated user

[Source: architecture/data-models.md]

#### 2. `user_connections` Table

Stores encrypted OAuth tokens for external platforms.

**Key Fields:**

- `clerkUserId`: string (Clerk user ID)
- `platform`: string (values: "twitter" | "linkedin")
- `accessToken`: string (must be encrypted before storage)
- `refreshToken`: string (must be encrypted before storage)
- `expiresAt`: number (timestamp)

**Index:** `by_user_platform` on `["clerkUserId", "platform"]` - enables quick, secure retrieval of credentials for a specific user and platform

[Source: architecture/data-models.md]

### Security Requirements

**Authentication & Authorization:**

- Clerk middleware (`middleware.ts`) protects core application routes on the client side
- All Convex Queries and Mutations must use `ctx.auth.getUserIdentity()` to verify the user is authenticated
- All data access must verify `userId` against the document's `clerkUserId` to ensure single-user isolation
- OAuth tokens stored in `user_connections` must be encrypted at the application level (implementation deferred to Story 1.3)

[Source: architecture/security.md#authentication-authorization]

### Component Architecture

**App Shell:**

- Location: `app/layout.tsx`
- Purpose: Provides Clerk and Convex contexts, handles global styling
- Must wrap application with both `ClerkProvider` and `ConvexClientProvider`

[Source: architecture/frontend-architecture.md#component-architecture]

### Routing Architecture

The application uses the **Next.js App Router** structure. For this story, we need to ensure the base routing is functional with Clerk protection enabled.

Example protected routes (to be implemented in future stories):

- `app/schedule/page.tsx` (Post Creation/Scheduling)
- `app/dashboard/page.tsx` (List View / Post Management)
- `app/history/page.tsx` (Post History)

[Source: architecture/frontend-architecture.md#routing-architecture]

### Development Commands Reference

**Starting Development:**

```bash
npm run dev              # Runs both frontend and Convex backend in parallel
npm run dev:frontend     # Next.js dev server only
npm run dev:backend      # Convex dev server only
npm run predev           # Convex dev + dashboard
```

**Convex Commands:**

```bash
npx convex dev           # Start Convex dev deployment
npx convex dashboard     # Open Convex dashboard
npx convex deploy        # Deploy Convex functions to production
```

### Project Structure Notes

The existing repository structure aligns with the architecture specification. No structural conflicts identified.

### Previous Story Insights

This is the first story in the epic. No previous story context available.

## Testing

### Testing Standards

**Test Levels Required:**

1. **Unit Tests:**
   - Framework: Jest (or equivalent)
   - Focus Areas: Middleware configuration logic, schema validation
   - Location: Create test files adjacent to implementation files (e.g., `middleware.test.ts`)

2. **Integration Tests:**
   - Framework: Jest with mocking libraries
   - Focus Areas:
     - Authentication flow on protected routes
     - Convex database schema and index validation
     - Clerk/Convex integration via `ctx.auth.getUserIdentity()`
   - Location: `__tests__/integration/` directory (create if needed)

[Source: architecture/testing-strategy.md]

### Error Handling for This Story

- Client/UI: Use error boundaries to catch and display authentication errors
- Ensure Clerk components handle authentication failures gracefully
- Log any connection errors with Convex for debugging

[Source: architecture/testing-strategy.md#error-handling-strategy]

### Test Coverage Requirements

- All authentication middleware logic must have unit tests
- Database schema must be validated via integration tests
- Authentication flow must be tested end-to-end with mock user sessions

## Change Log

| Date       | Version | Description                    | Author           |
| :--------- | :------ | :----------------------------- | :--------------- |
| 2025-10-30 | 1.0     | Initial story creation (Draft) | Scrum Master Bob |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929 (Sonnet 4.5)

### Debug Log References

No debug log entries required for this story.

### Completion Notes List

- Successfully configured Clerk authentication with ClerkProvider in app/layout.tsx
- Uncommented and configured Clerk JWT authentication in convex/auth.config.ts
- Created .env.example file documenting all required environment variables
- Implemented complete database schema with `posts` and `user_connections` tables
- Added proper indexes: `by_user` on posts table and `by_user_platform` on user_connections table
- Set up Jest testing infrastructure with ts-jest preset
- Created comprehensive test suite covering middleware, schema, and authentication integration
- All 17 tests passing successfully
- Code passes ESLint and TypeScript compilation

### File List

**Created:**
- `.env.example` - Environment variable documentation
- `jest.config.ts` - Jest configuration for TypeScript
- `jest.setup.ts` - Jest setup file
- `__tests__/middleware.test.ts` - Middleware configuration tests
- `__tests__/schema.test.ts` - Schema validation tests
- `__tests__/integration/auth.test.tsx` - Authentication integration tests

**Modified:**
- `convex/auth.config.ts` - Uncommented Clerk provider configuration
- `convex/schema.ts` - Added posts and user_connections tables with indexes
- `package.json` - Added test scripts and testing dependencies

## QA Results

_To be completed by QA Agent_
