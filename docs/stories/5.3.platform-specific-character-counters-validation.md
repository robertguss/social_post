# Story 5.3: Platform-Specific Character Counters & Validation

## Status

Ready

## Story

**As a** content creator,
**I want** accurate, real-time character counters for each platform,
**so that** I know immediately if my content exceeds platform limits.

## Acceptance Criteria

1. Twitter text field displays a character counter showing "X / 280" with current count and limit.
2. LinkedIn text field displays a character counter showing "X / 3,000" with current count and limit.
3. Counters update in real-time as the user types (no debounce).
4. Twitter counter shows warning styling (yellow/orange) at 260 characters.
5. Twitter counter shows error styling (red) at 280+ characters and the "Schedule" button is disabled.
6. LinkedIn counter shows warning styling at 2,900 characters.
7. LinkedIn counter shows error styling at 3,000+ characters and the "Schedule" button is disabled.
8. Character counting accounts for emoji, special characters, and URLs correctly per platform rules.

## Tasks / Subtasks

- [ ] **Task 1: Create character counting utility functions** (AC: 8)
  - [ ] Create new file `lib/utils/characterCount.ts`
  - [ ] Implement `getTwitterCharacterCount(content: string): number` function
  - [ ] Implement `getLinkedInCharacterCount(content: string): number` function
  - [ ] Handle emoji counting correctly (Twitter counts some emoji as 2 chars, LinkedIn as 1)
  - [ ] Handle URL counting correctly (Twitter auto-shortens URLs to ~23 chars via t.co)
  - [ ] Research Twitter's exact character counting rules and implement
  - [ ] Research LinkedIn's character counting rules and implement
  - [ ] Add JSDoc comments documenting platform-specific counting rules

- [ ] **Task 2: Create CharacterCounter component** (AC: 1, 2, 3, 4, 5, 6, 7)
  - [ ] Create new component `components/ui/CharacterCounter.tsx`
  - [ ] Define props: `currentCount: number`, `maxCount: number`, `warningThreshold: number`, `platform: 'twitter' | 'linkedin'`
  - [ ] Display count in format "X / Y" (e.g., "250 / 280")
  - [ ] Apply styling based on count:
    - Default: neutral color (gray/blue)
    - Warning: yellow/orange when count >= warningThreshold
    - Error: red when count >= maxCount
  - [ ] Add visual indicators (icons or badges) for warning/error states
  - [ ] Ensure component is accessible (aria-live for screen readers)

- [ ] **Task 3: Integrate CharacterCounter into DualPlatformTextFields** (AC: 1, 2, 3)
  - [ ] In `DualPlatformTextFields.tsx`, import character counting utility functions
  - [ ] Calculate Twitter character count on every render using `getTwitterCharacterCount(twitterContent)`
  - [ ] Calculate LinkedIn character count on every render using `getLinkedInCharacterCount(linkedInContent)`
  - [ ] Add `<CharacterCounter>` component below or beside Twitter text area
    - Pass currentCount, maxCount=280, warningThreshold=260, platform='twitter'
  - [ ] Add `<CharacterCounter>` component below or beside LinkedIn text area
    - Pass currentCount, maxCount=3000, warningThreshold=2900, platform='linkedin'
  - [ ] Ensure counters update in real-time (no debounce) as user types

- [ ] **Task 4: Implement form validation based on character counts** (AC: 5, 7)
  - [ ] In post creation form component (e.g., `PostScheduler.tsx` or parent form), track character count validation state
  - [ ] Create validation function `validateCharacterCounts()`:
    - Check if Twitter is enabled and count > 280 → invalid
    - Check if LinkedIn is enabled and count > 3000 → invalid
    - Return boolean: true if valid, false if invalid
  - [ ] Update form state with `isCharacterCountValid` boolean
  - [ ] Disable "Schedule" button when `isCharacterCountValid === false`
  - [ ] Add visual feedback near the Schedule button explaining why it's disabled (e.g., "Character limit exceeded")

- [ ] **Task 5: Lift character count state to parent form for validation** (AC: 5, 7)
  - [ ] In `DualPlatformTextFields.tsx`, add new callback props: `onTwitterCharacterCountChange`, `onLinkedInCharacterCountChange`
  - [ ] Call these callbacks whenever character counts change (pass the current count)
  - [ ] In parent form component, receive character counts via these callbacks
  - [ ] Store character counts in parent form state: `twitterCharCount`, `linkedInCharCount`
  - [ ] Use these counts for form-level validation logic (Task 4)
  - [ ] Pass validation state back to `DualPlatformTextFields` if needed for additional UI feedback

- [ ] **Task 6: Handle edge cases and special characters** (AC: 8)
  - [ ] Test character counting with various emoji (single-character, multi-codepoint, skin tones)
  - [ ] Test with URLs of different lengths
  - [ ] Test with newlines, special characters, and non-English characters
  - [ ] Verify Twitter's t.co URL shortening behavior (any URL counts as ~23 chars)
  - [ ] Document any platform-specific quirks or limitations discovered
  - [ ] Add edge case handling in counting functions

- [ ] **Task 7: Add unit tests for character counting logic** (AC: 1-8)
  - [ ] Create test file `lib/utils/characterCount.test.ts`
  - [ ] Test: Basic ASCII text counting for Twitter and LinkedIn
  - [ ] Test: Emoji counting (single, multi-codepoint, with skin tones)
  - [ ] Test: URL counting for Twitter (verify ~23 char count regardless of URL length)
  - [ ] Test: URL counting for LinkedIn (actual character count)
  - [ ] Test: Special characters, newlines, and non-English text
  - [ ] Test: Empty string and edge cases (null, undefined)

- [ ] **Task 8: Add component tests for CharacterCounter** (AC: 1-7)
  - [ ] Create test file `components/ui/CharacterCounter.test.tsx`
  - [ ] Test: Counter displays correct format "X / Y"
  - [ ] Test: Styling changes at warning threshold
  - [ ] Test: Styling changes at max threshold
  - [ ] Test: Accessibility attributes are present
  - [ ] Test: Visual indicators (icons) appear for warning/error states

- [ ] **Task 9: Add integration tests for form validation** (AC: 5, 7)
  - [ ] Extend test file for post creation form component
  - [ ] Test: Schedule button is disabled when Twitter count > 280 and Twitter is enabled
  - [ ] Test: Schedule button is disabled when LinkedIn count > 3000 and LinkedIn is enabled
  - [ ] Test: Schedule button is enabled when both counts are within limits
  - [ ] Test: Schedule button is enabled when a platform is disabled (even if its count exceeds limit)
  - [ ] Test: Error message displays near Schedule button when validation fails

## Dev Notes

### Previous Story Context

Story 5.1 created the `DualPlatformTextFields.tsx` component with separate text areas for Twitter and LinkedIn. Story 5.2 added smart pre-population from Twitter to LinkedIn. This story adds real-time character counting and validation to ensure posts stay within platform limits.

### Frontend Architecture

[Source: docs/architecture/frontend-architecture.md#Component Architecture]

- **Component Locations**:
  - Enhance `components/features/DualPlatformTextFields.tsx` (from Stories 5.1, 5.2)
  - Create new `components/ui/CharacterCounter.tsx` UI primitive
  - Create utility file `lib/utils/characterCount.ts` for counting logic
- **UI Primitives**: Use shadcn/ui Badge or custom styled component for counter display
- **State Management**: Character counts managed in parent form component, passed down to child components

### Tech Stack

[Source: docs/architecture/tech-stack.md]

- **Frontend Framework**: Next.js 15.5.4, React 19
- **UI Component Library**: shadcn/ui - Use Badge or custom component for counter
- **Styling**: Tailwind CSS 4 - Use utility classes for warning/error colors
- **Language**: TypeScript - Strongly type all character counting functions

### Character Counting Rules

**Twitter/X Rules**:

- Maximum: 280 characters
- Warning threshold: 260 characters (as per PRD)
- **URL Handling**: Twitter auto-shortens all URLs via t.co, counting them as ~23 characters regardless of actual length
- **Emoji Handling**: Most emoji count as 2 characters in Twitter's system (due to surrogate pairs), though some newer emoji may vary
- **Line breaks**: Count as 1 character
- **Reference**: Twitter API documentation on character counting (research required)

**LinkedIn Rules**:

- Maximum: 3,000 characters
- Warning threshold: 2,900 characters (as per PRD)
- **URL Handling**: URLs count as their actual character length (no shortening)
- **Emoji Handling**: Most emoji count as 1 character
- **Line breaks**: Count as 1 character
- **Reference**: LinkedIn API documentation (research required)

### Implementation Patterns

**Character Counting Utility Structure**:

```typescript
// lib/utils/characterCount.ts

/**
 * Counts characters for Twitter, accounting for t.co URL shortening.
 * All URLs are counted as ~23 characters regardless of length.
 */
export function getTwitterCharacterCount(content: string): number {
  // Replace URLs with placeholder of 23 chars
  const urlRegex = /https?:\/\/[^\s]+/g;
  const contentWithShortUrls = content.replace(urlRegex, "x".repeat(23));

  // Count remaining characters
  // Note: May need more sophisticated emoji/surrogate pair handling
  return Array.from(contentWithShortUrls).length;
}

/**
 * Counts characters for LinkedIn, using actual character count.
 */
export function getLinkedInCharacterCount(content: string): number {
  return Array.from(content).length;
}
```

**CharacterCounter Component Pattern**:

```typescript
// components/ui/CharacterCounter.tsx

interface CharacterCounterProps {
  currentCount: number;
  maxCount: number;
  warningThreshold: number;
  platform: 'twitter' | 'linkedin';
}

export function CharacterCounter({
  currentCount,
  maxCount,
  warningThreshold,
  platform
}: CharacterCounterProps) {
  const isWarning = currentCount >= warningThreshold && currentCount < maxCount;
  const isError = currentCount >= maxCount;

  const colorClass = isError
    ? 'text-red-600'
    : isWarning
    ? 'text-orange-500'
    : 'text-gray-600';

  return (
    <div className={`text-sm font-medium ${colorClass}`} aria-live="polite">
      {currentCount} / {maxCount}
      {isError && <span className="ml-2">⚠️</span>}
    </div>
  );
}
```

**Form Validation Pattern**:

```typescript
// In parent form component (e.g., PostScheduler.tsx)

const [twitterCharCount, setTwitterCharCount] = useState(0);
const [linkedInCharCount, setLinkedInCharCount] = useState(0);

const isValidCharacterCounts =
  (!twitterEnabled || twitterCharCount <= 280) &&
  (!linkedInEnabled || linkedInCharCount <= 3000);

const canSubmit = isValidCharacterCounts && /* other validation checks */;

<Button disabled={!canSubmit}>
  Schedule Post
</Button>
```

### Testing

[Source: docs/architecture/testing-strategy.md#Unit Testing]

- **Test Level**: Unit tests for character counting functions, Component tests for CharacterCounter UI
- **Tools**: Jest for utility function tests, React Testing Library for component tests
- **Testing Focus**:
  - Character Counting logic (critical!)
  - URL detection and handling
  - Emoji and special character handling
  - Counter display and styling changes
  - Form validation based on character counts

**Testing Requirements**:

- Test character counting accuracy extensively with edge cases
- Test URL regex and shortening logic for Twitter
- Test emoji counting (use actual emoji strings in tests)
- Mock parent component state for integration tests

### Accessibility Considerations

- Use `aria-live="polite"` on CharacterCounter to announce count changes to screen readers
- Ensure error states are communicated via both color AND text/icons (not color alone)
- Add `aria-describedby` on text areas linking to their respective character counters
- When Schedule button is disabled, provide clear `aria-label` explaining why

### Implementation Notes

1. **Real-time Updates**: Character counters must update on every keystroke (no debounce), so use efficient counting functions to avoid performance issues.

2. **URL Regex**: Use a robust URL regex for detecting URLs in content. Consider edge cases like URLs without http:// prefix.

3. **Emoji Handling**: JavaScript's `.length` property doesn't accurately count emoji. Use `Array.from(string).length` or a library like `grapheme-splitter` for accurate counting.

4. **Twitter t.co Shortening**: Twitter shortens ALL URLs to ~23 characters via their t.co service. This applies regardless of the original URL length (even short URLs like "x.com" count as 23 chars).

5. **Platform API Documentation**: Research actual Twitter and LinkedIn character counting implementations to match their behavior exactly. The Twitter API v2 has specific endpoints for character counting validation.

6. **Warning Thresholds**: Per CLAUDE.md, Twitter warns at 260 chars, LinkedIn warns at 2,900 chars. These thresholds give users a buffer before hitting the hard limit.

7. **Form Validation Priority**: This story implements critical validation logic referenced in CLAUDE.md. Ensure character validation is bulletproof to prevent API errors on publish.

## Change Log

| Date       | Version | Description                 | Author       |
| :--------- | :------ | :-------------------------- | :----------- |
| 2025-11-03 | 1.0     | Initial story draft created | Scrum Master |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
