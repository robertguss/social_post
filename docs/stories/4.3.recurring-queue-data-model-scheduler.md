# Story 4.3: Recurring Queue Data Model & Scheduler

## Status

Draft

## Story

**As an** engineer,
**I want** a database schema and scheduling logic for recurring post queues,
**so that** posts can be automatically rescheduled at defined intervals.

## Acceptance Criteria

1. A `recurring_queues` table is defined in the Convex schema with fields: `clerkUserId`, `originalPostId`, `status` (active/paused), `interval` (days), `nextScheduledTime`, `lastExecutedTime`, `executionCount`, `maxExecutions` (optional).
2. The `recurring_queues` table has an index `by_user_status` on `["clerkUserId", "status"]` for efficient active queue queries.
3. A Convex scheduled function runs daily to check for queues due for execution (`nextScheduledTime` <= now).
4. When a queue is due, the scheduled function clones the original post and schedules it using the existing publishing logic.
5. After execution, `nextScheduledTime` is updated to `lastExecutedTime` + `interval`, and `executionCount` is incremented.
6. If `maxExecutions` is set and reached, the queue status is automatically set to "completed".
7. All queue operations are scoped to the authenticated user's `clerkUserId`.

## Tasks / Subtasks

- [ ] **Task 1: Define recurring_queues table in schema** (AC: 1)
- [ ] **Task 2: Create by_user_status index** (AC: 2)
- [ ] **Task 3: Implement createRecurringQueue mutation** (AC: 1, 7)
- [ ] **Task 4: Create daily scheduled function** (AC: 3)
- [ ] **Task 5: Implement queue execution logic** (AC: 4)
- [ ] **Task 6: Update queue after execution** (AC: 5, 6)
- [ ] **Task 7: Write tests for queue scheduler** (AC: 3-6)

## Dev Notes

### Architecture Context

Core story for recurring queue functionality. Establishes automated post rescheduling system.

### Data Models

**recurring_queues table:**
- `clerkUserId`: string
- `originalPostId`: id("posts")
- `status`: "active" | "paused" | "completed"
- `interval`: number (days)
- `nextScheduledTime`: number (timestamp)
- `lastExecutedTime`: optional number
- `executionCount`: number (default 0)
- `maxExecutions`: optional number

**Indexes:**
- `by_user_status`: ["clerkUserId", "status"]

## Testing

Tests for queue creation, daily execution, and max executions handling.

## Change Log

| Date       | Version | Description                          | Author     |
| :--------- | :------ | :----------------------------------- | :--------- |
| 2025-11-01 | 1.0     | Initial draft created from Epic 4.3. | Sarah (PO) |

## Dev Agent Record

To be populated by Dev Agent during implementation.

## QA Results

To be populated by QA Agent after implementation review.
