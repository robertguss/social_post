# Story 4.5: Queue Conflict Detection & Resolution

## Status

Draft

## Story

**As a** content creator,
**I want** the system to detect and warn me about scheduling conflicts,
**so that** I don't accidentally post duplicate content at the same time.

## Acceptance Criteria

1. When creating a recurring queue, the system checks for existing queues with the same original post ID.
2. If a duplicate queue exists (active or paused), a warning message displays: "A queue for this post already exists."
3. The warning includes options: "View Existing Queue", "Create Anyway", or "Cancel".
4. When a queue's next scheduled time conflicts with an already scheduled post (within 1 hour window), a conflict notification is displayed in the Queues page.
5. Users can manually adjust the queue's next scheduled time to resolve conflicts.
6. The system prevents scheduling if the conflict is exact (same post, same platform, same exact time).
7. Conflict detection works across both manually scheduled posts and queue-generated posts.

## Tasks / Subtasks

- [ ] **Task 1: Create duplicate queue detection query** (AC: 1, 2)
  - [ ] In `convex/queues.ts`, create query `checkDuplicateQueue`
  - [ ] Args: `originalPostId: v.id("posts")`
  - [ ] Verify user authentication
  - [ ] Query recurring_queues for queues matching originalPostId and clerkUserId
  - [ ] Filter results to include only "active" and "paused" queues (exclude "completed")
  - [ ] Return array of duplicate queues (or null/empty if none found)
  - [ ] Include queue status and nextScheduledTime in results

- [ ] **Task 2: Update createQueue mutation to check duplicates** (AC: 1, 2, 3)
  - [ ] In `convex/queues.ts`, modify `createQueue` mutation
  - [ ] Before creating queue, call internal duplicate check logic
  - [ ] If duplicate exists, throw error with code "DUPLICATE_QUEUE_EXISTS"
  - [ ] Include duplicate queue details in error response (queueId, status)
  - [ ] OR: Add optional `force: v.optional(v.boolean())` parameter to allow bypassing check
  - [ ] If `force: true`, skip duplicate check and create queue anyway
  - [ ] Document this behavior in mutation comments

- [ ] **Task 3: Create conflict detection query** (AC: 4, 7)
  - [ ] In `convex/queues.ts`, create query `detectSchedulingConflicts`
  - [ ] Verify user authentication
  - [ ] Fetch all user's active queues
  - [ ] Fetch all user's scheduled posts (status "scheduled")
  - [ ] For each queue, check if nextScheduledTime conflicts with any scheduled post
  - [ ] Conflict definition: times are within 1 hour (3600000 ms) of each other AND posts target the same platform
  - [ ] Return array of conflicts: `{ queueId, postId, queueTime, postTime, platform }`
  - [ ] Handle dual-platform posts (check Twitter and LinkedIn separately)

- [ ] **Task 4: Create ConflictWarning component** (AC: 2, 3)
  - [ ] Create new file: `components/features/ConflictWarning.tsx`
  - [ ] Accept props: `duplicateQueue` object (from duplicate check)
  - [ ] Display warning banner with alert icon (orange/warning color)
  - [ ] Message: "A queue for this post already exists."
  - [ ] Display duplicate queue details: status, interval, next scheduled time
  - [ ] Render three action buttons:
    - "View Existing Queue" - navigates to Queues page with queue highlighted
    - "Create Anyway" - proceeds with queue creation (bypasses check)
    - "Cancel" - closes modal/cancels action
  - [ ] Style with shadcn/ui Alert or custom banner component
  - [ ] Make accessible (keyboard navigation, screen reader support)

- [ ] **Task 5: Integrate duplicate check into queue creation flow** (AC: 1, 2, 3)
  - [ ] In QueueCreateModal (from Story 4.4) or wherever queue creation happens
  - [ ] Before submitting createQueue mutation, call `checkDuplicateQueue` query
  - [ ] If duplicates found, display ConflictWarning component
  - [ ] Handle "View Existing Queue" button: navigate to /queues with URL param or scroll to queue
  - [ ] Handle "Create Anyway" button: call createQueue mutation with `force: true`
  - [ ] Handle "Cancel" button: close modal without creating queue
  - [ ] If no duplicates found, proceed with normal queue creation

- [ ] **Task 6: Add conflict indicators to QueueCard** (AC: 4)
  - [ ] In `components/features/QueueCard.tsx`, accept new prop: `conflicts: Conflict[]`
  - [ ] If conflicts exist for this queue, display conflict warning icon/badge
  - [ ] Use orange/warning color for conflict indicator
  - [ ] Show tooltip on hover with conflict details: "Conflicts with scheduled post on {date}"
  - [ ] Make conflict indicator clickable to open conflict resolution modal
  - [ ] Add aria-label for accessibility: "This queue has scheduling conflicts"

- [ ] **Task 7: Create ConflictResolutionModal component** (AC: 5)
  - [ ] Create new file: `components/features/ConflictResolutionModal.tsx`
  - [ ] Accept props: `queue` object, `conflicts: Conflict[]`, `isOpen: boolean`, `onClose: () => void`
  - [ ] Display modal with list of conflicts
  - [ ] For each conflict, show:
    - Conflicting post content preview
    - Queue scheduled time vs. post scheduled time
    - Time difference (e.g., "30 minutes apart")
    - Platform (Twitter/LinkedIn)
  - [ ] Provide resolution options:
    - "Adjust Queue Time" - opens time picker to modify queue's nextScheduledTime
    - "Adjust Post Time" - navigates to post edit page (Story 2.5)
    - "Ignore" - dismiss conflict (user accepts the conflict)
  - [ ] Implement "Adjust Queue Time" option:
    - Display date/time picker
    - Call updateQueue mutation with new nextScheduledTime
    - Re-check for conflicts after update
  - [ ] Close modal after conflict is resolved or ignored

- [ ] **Task 8: Integrate conflict detection into QueueList** (AC: 4)
  - [ ] In `components/features/QueueList.tsx`, call `detectSchedulingConflicts` query
  - [ ] Pass conflicts to each QueueCard component
  - [ ] Display global conflict summary at top of page if any conflicts exist
  - [ ] Summary: "⚠️ {N} queue(s) have scheduling conflicts. Review and resolve."
  - [ ] Make summary clickable to highlight/scroll to conflicting queues
  - [ ] Update conflicts display reactively when queues or posts change

- [ ] **Task 9: Implement exact conflict prevention** (AC: 6)
  - [ ] In `convex/queues.ts`, create validation function `checkExactConflict`
  - [ ] Parameters: `originalPostId`, `scheduledTime`, `platform`
  - [ ] Query posts table for scheduled posts matching:
    - Same originalPostId (or clonedFromPostId)
    - Same platform (twitterScheduledTime or linkedInScheduledTime)
    - Exact same timestamp (within 1 second tolerance)
  - [ ] Return true if exact conflict found, false otherwise
  - [ ] Modify createQueue and updateQueue mutations to call this validation
  - [ ] If exact conflict found, throw error: "EXACT_CONFLICT" with message: "A post is already scheduled for this exact time and platform"
  - [ ] Display error to user in UI (red error toast)

- [ ] **Task 10: Add "View Existing Queue" navigation** (AC: 3)
  - [ ] Create helper function to navigate to Queues page with specific queue highlighted
  - [ ] Use Next.js router: `router.push(/queues?highlight=${queueId})`
  - [ ] In QueueList component, read `highlight` URL parameter
  - [ ] If highlight param exists, scroll to matching queue and add visual highlight effect
  - [ ] Highlight effect: temporary border/shadow animation (fade out after 2 seconds)
  - [ ] Clear highlight param after animation completes

- [ ] **Task 11: Test duplicate queue detection** (AC: 1, 2)
  - [ ] Create test file or extend: `convex/queues.test.ts`
  - [ ] Test checkDuplicateQueue returns existing queue when duplicate exists
  - [ ] Test checkDuplicateQueue returns empty when no duplicates
  - [ ] Test checkDuplicateQueue includes only active and paused queues (not completed)
  - [ ] Test checkDuplicateQueue enforces user scoping (doesn't return other users' queues)

- [ ] **Task 12: Test conflict detection logic** (AC: 4, 6, 7)
  - [ ] Test detectSchedulingConflicts identifies conflicts within 1 hour window
  - [ ] Test conflict detection checks platform matching (Twitter vs LinkedIn)
  - [ ] Test conflict detection works for queue vs. manually scheduled post
  - [ ] Test conflict detection works for queue vs. queue-generated post
  - [ ] Test exact conflict prevention rejects same post/platform/time
  - [ ] Test no false positives (posts >1 hour apart are not flagged)

- [ ] **Task 13: Test ConflictWarning component** (AC: 2, 3)
  - [ ] Create test file: `components/features/ConflictWarning.test.tsx`
  - [ ] Test component displays warning message
  - [ ] Test component displays duplicate queue details
  - [ ] Test "View Existing Queue" button navigates correctly
  - [ ] Test "Create Anyway" button calls createQueue with force flag
  - [ ] Test "Cancel" button closes warning without creating queue

- [ ] **Task 14: Test conflict resolution flow** (AC: 5)
  - [ ] Test conflict indicator appears on queue cards with conflicts
  - [ ] Test clicking conflict indicator opens ConflictResolutionModal
  - [ ] Test modal displays all conflicts for queue
  - [ ] Test "Adjust Queue Time" updates queue and re-checks conflicts
  - [ ] Test modal closes after conflict resolution
  - [ ] Test "Ignore" button dismisses conflict

- [ ] **Task 15: Test exact conflict prevention** (AC: 6)
  - [ ] Test createQueue throws error when exact conflict exists
  - [ ] Test updateQueue throws error when creating exact conflict
  - [ ] Test error message is displayed to user in UI
  - [ ] Test queue creation succeeds when no exact conflict

## Dev Notes

### Architecture Context

This story completes Epic 4 by adding intelligent conflict detection and prevention for recurring queues. It prevents users from accidentally creating duplicate queues or scheduling posts that conflict with existing scheduled content.

**Key Design Decisions:**

- **Two levels of conflict detection:**
  1. **Duplicate queues**: Prevents creating multiple queues for the same post (soft warning with override option)
  2. **Scheduling conflicts**: Detects when queue execution time conflicts with already scheduled posts (1 hour window)

- **Exact conflict prevention**: Hard block on creating posts scheduled for the exact same time/platform (no override)

- **User-friendly resolution**: Provides clear options to resolve conflicts (adjust times, view existing queue, or proceed anyway)

- **Non-blocking warnings**: Duplicate queue check allows "Create Anyway" option for power users who intentionally want multiple queues

- **Real-time conflict display**: Conflicts shown in queue cards with visual indicators (reactive updates)

[Source: docs/prd/6-epic-details.md:323-336]

### Data Models

This story uses existing tables from previous stories:

**recurring_queues table** (from Story 4.3):
- `originalPostId: v.id("posts")` - Used for duplicate queue detection
- `nextScheduledTime: v.number()` - Used for conflict detection

**posts table** (existing):
- `twitterScheduledTime: v.optional(v.number())`
- `linkedInScheduledTime: v.optional(v.number())`
- `clonedFromPostId: v.optional(v.id("posts"))` - Used to match queue-generated posts
- `status: v.string()` - Filter for "scheduled" posts only

No schema changes required for this story.

[Source: convex/schema.ts, docs/stories/4.3.recurring-queue-data-model-scheduler.md]

### Conflict Detection Logic

**Duplicate Queue Check:**
```typescript
// In checkDuplicateQueue query
const duplicates = await ctx.db
  .query("recurring_queues")
  .withIndex("by_user_status", (q) => q.eq("clerkUserId", userId))
  .filter((q) =>
    q.and(
      q.eq(q.field("originalPostId"), originalPostId),
      q.or(
        q.eq(q.field("status"), "active"),
        q.eq(q.field("status"), "paused")
      )
    )
  )
  .collect();
```

**Scheduling Conflict Check:**
```typescript
// In detectSchedulingConflicts query
const ONE_HOUR = 3600000; // 1 hour in milliseconds

const isConflict = (queueTime: number, postTime: number) => {
  const timeDiff = Math.abs(queueTime - postTime);
  return timeDiff <= ONE_HOUR;
};

// For each queue and each scheduled post:
if (isConflict(queue.nextScheduledTime, post.twitterScheduledTime)) {
  conflicts.push({
    queueId: queue._id,
    postId: post._id,
    queueTime: queue.nextScheduledTime,
    postTime: post.twitterScheduledTime,
    platform: "twitter"
  });
}
```

**Exact Conflict Check:**
```typescript
// In checkExactConflict function
const EXACT_TOLERANCE = 1000; // 1 second in milliseconds

const isExactConflict = (time1: number, time2: number) => {
  return Math.abs(time1 - time2) <= EXACT_TOLERANCE;
};
```

### Component Architecture

**New Components:**

- **ConflictWarning.tsx**: Duplicate queue warning banner
  - Location: `components/features/ConflictWarning.tsx`
  - Displays when user tries to create duplicate queue
  - Provides "View Existing Queue", "Create Anyway", "Cancel" options

- **ConflictResolutionModal.tsx**: Scheduling conflict resolution modal
  - Location: `components/features/ConflictResolutionModal.tsx`
  - Displays list of conflicts for a queue
  - Provides options to adjust queue time, adjust post time, or ignore

**Modified Components:**

- **QueueCard.tsx**: Add conflict indicator
  - Display warning badge when conflicts exist
  - Show tooltip with conflict details
  - Click to open ConflictResolutionModal

- **QueueList.tsx**: Integrate conflict detection
  - Fetch conflicts using `detectSchedulingConflicts` query
  - Pass conflicts to QueueCard components
  - Display global conflict summary

**Modified Queries/Mutations:**

- **createQueue** mutation: Add duplicate check and exact conflict validation
- **updateQueue** mutation: Add exact conflict validation when changing nextScheduledTime

[Source: docs/architecture/frontend-architecture.md#component-architecture]

### Previous Story Insights

**From Story 4.3 (Recurring Queue Data Model & Scheduler):**

- Queue CRUD mutations in `convex/queues.ts`
- `getQueues` query fetches user's queues
- Queue status: "active", "paused", "completed"
- nextScheduledTime is recalculated when resuming queues

[Source: docs/stories/4.3.recurring-queue-data-model-scheduler.md]

**From Story 4.4 (Queue Management UI):**

- QueueList and QueueCard components structure
- Queue creation flow (QueueCreateModal)
- Edit queue functionality (QueueEditModal)
- Can reuse modal patterns for conflict resolution

[Source: docs/stories/4.4.queue-management-ui-pause-resume-edit.md]

**From Story 2.5 (Post Management - Edit/Delete/Reschedule):**

- Post editing functionality exists
- Can navigate users to post edit page to resolve conflicts
- Rescheduling logic updates scheduled times and Convex actions

[Source: docs/stories/2.5.post-management-edit-delete-reschedule.md]

### UX Flow Examples

**Duplicate Queue Warning Flow:**

1. User clicks "Create Queue" and selects a post
2. User fills in interval and time, clicks "Create"
3. System detects existing queue for same post
4. ConflictWarning displays with message and options
5. User options:
   - "View Existing Queue" → Navigate to /queues?highlight={queueId}
   - "Create Anyway" → Call createQueue with force=true
   - "Cancel" → Close modal, return to form

**Scheduling Conflict Resolution Flow:**

1. User views Queues page
2. QueueCard shows orange conflict badge
3. Global summary: "⚠️ 2 queue(s) have scheduling conflicts"
4. User clicks conflict badge on queue card
5. ConflictResolutionModal opens showing conflicts
6. For each conflict: "Queue posts at 2:00 PM, but you have a post scheduled for 2:30 PM (same platform)"
7. User options:
   - "Adjust Queue Time" → Opens time picker, updates queue
   - "Adjust Post Time" → Navigate to edit post page
   - "Ignore" → Dismiss conflict, user accepts it

**Exact Conflict Prevention Flow:**

1. User tries to create/update queue with time that exactly matches existing scheduled post
2. System throws "EXACT_CONFLICT" error
3. Red error toast displays: "A post is already scheduled for this exact time and platform"
4. Queue creation/update fails
5. User must choose different time to proceed

### Tech Stack & Libraries

- **Frontend**: Next.js 15.5.4, React 19, shadcn/ui components, Tabler icons
- **Backend**: Convex queries and mutations
- **State Management**: Convex `useQuery` and `useMutation` hooks
- **UI Components**: shadcn/ui Alert, Dialog, Badge, Tooltip
- **Date/Time**: Native JavaScript Date API for time calculations

[Source: docs/architecture/tech-stack.md]

### Error Handling

**Error Codes:**
- `DUPLICATE_QUEUE_EXISTS` - Duplicate queue detected (soft warning, can override)
- `EXACT_CONFLICT` - Exact scheduling conflict (hard block, cannot override)
- `QUEUE_NOT_FOUND` - Queue doesn't exist
- `UNAUTHORIZED` - User doesn't own queue/post

**User-Facing Messages:**
- Duplicate: "A queue for this post already exists. You can view it or create a new one anyway."
- Exact conflict: "Cannot schedule: a post is already scheduled for this exact time and platform."
- Generic error: "Failed to create queue. Please try again."

### Testing

**Test Locations:**
- Backend tests: Extend `convex/queues.test.ts`
- Component tests: `components/features/ConflictWarning.test.tsx`, `components/features/ConflictResolutionModal.test.tsx`

**Testing Framework:**
- Jest for unit tests
- React Testing Library for component tests
- Mock Convex hooks and database context

**Key Test Cases:**
1. Unit: checkDuplicateQueue correctly identifies duplicate queues
2. Unit: detectSchedulingConflicts identifies conflicts within 1 hour
3. Unit: checkExactConflict prevents exact same time/platform
4. Integration: Duplicate warning displays when creating duplicate queue
5. Integration: Conflict indicator appears on queue cards
6. Integration: "Create Anyway" bypasses duplicate check
7. Integration: Exact conflict throws error and prevents creation
8. Integration: Adjusting queue time resolves conflict
9. Edge case: Conflict detection handles dual-platform posts correctly
10. Edge case: No false positives for posts >1 hour apart

[Source: docs/architecture/testing-strategy.md]

### Accessibility Considerations

- Conflict warnings must have role="alert" for screen reader announcements
- Conflict indicators must have clear aria-labels (e.g., "Warning: scheduling conflict")
- Modal dialogs must trap focus and be keyboard navigable
- All action buttons must have accessible labels
- Warning colors (orange/red) must meet WCAG contrast requirements
- Tooltips must be accessible via keyboard focus

### Performance Considerations

**Optimization Strategies:**
- Run duplicate check on-demand (during queue creation), not on every render
- Cache conflict detection results in client state (re-fetch on queue/post changes)
- Limit conflict detection to queues with nextScheduledTime in near future (next 30 days)
- Use Convex indexes for fast duplicate/conflict queries
- Debounce time picker updates in conflict resolution modal

**Scalability:**
- For MVP (single user), checking all queues and posts is fast
- For multi-user version: add pagination or limit conflict checks to active queues only

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-01 | 1.0 | Initial story draft created | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

_(To be filled by dev agent during implementation)_

### Debug Log References

_(To be filled by dev agent during implementation)_

### Completion Notes List

_(To be filled by dev agent during implementation)_

### File List

_(To be filled by dev agent during implementation)_

## QA Results

_(To be filled by QA agent after implementation)_
