# Story 6.5: Custom User Preference Overrides

## Status
Draft

## Story
**As a** content creator,
**I want** to set my own preferred posting times,
**so that** recommendations align with my personal schedule and audience.

## Acceptance Criteria

1. A "Posting Preferences" settings page is added to the application.
2. Users can define their own "preferred posting windows" for each platform (e.g., "Twitter: Mon-Fri 7-9am, Sat 10am").
3. Preferred windows are stored in a `user_preferences` table with fields: `clerkUserId`, `platform`, `dayOfWeek`, `customTimeRanges`.
4. When custom preferences exist, the time suggestion algorithm prioritizes user-defined windows over research-based recommendations.
5. Users can reset preferences to default (research-based) recommendations at any time.
6. The settings page displays both custom preferences and default recommendations side-by-side for comparison.
7. Custom preferences are reflected immediately in the scheduler picker's recommended times.

## Tasks / Subtasks

- [ ] Task 1: Define `user_preferences` schema in `convex/schema.ts` (AC: 3)
  - [ ] Add `user_preferences` table with fields: `clerkUserId`, `platform`, `dayOfWeek`, `customTimeRanges`
  - [ ] Use Convex validators for type safety
  - [ ] Define `customTimeRanges` as array of objects: `[{ startHour: number, endHour: number }]` (in user's local timezone)
  - [ ] Add index `by_user_platform` on `["clerkUserId", "platform"]` for efficient lookups
  - [ ] Add index `by_user_platform_day` on `["clerkUserId", "platform", "dayOfWeek"]` for day-specific preferences
  - [ ] Document that times are stored in user's local timezone (different from recommendations table which uses UTC)

- [ ] Task 2: Create mutations for managing user preferences (AC: 2, 5)
  - [ ] Create `convex/userPreferences.ts` file for preference management
  - [ ] Implement mutation `setUserPreference` to create/update a preference
  - [ ] Implement mutation `deleteUserPreference` to remove a specific preference
  - [ ] Implement mutation `resetAllPreferences` to clear all user preferences (AC: 5)
  - [ ] Add authentication check to ensure users can only modify their own preferences
  - [ ] Validate that `startHour` and `endHour` are within 0-23 range
  - [ ] Validate that `dayOfWeek` is within 0-6 range

- [ ] Task 3: Create query to retrieve user preferences (AC: 4, 6)
  - [ ] Implement query `getUserPreferences` in `convex/userPreferences.ts`
  - [ ] Filter preferences by authenticated user's `clerkUserId`
  - [ ] Optionally filter by platform parameter
  - [ ] Return preferences grouped by platform and day of week
  - [ ] Include default recommendations for comparison (AC: 6)

- [ ] Task 4: Enhance recommendation algorithm to prioritize user preferences (AC: 4, 7)
  - [ ] Modify `getRecommendedTimes` query in `convex/recommendations.ts`
  - [ ] First, check if user has custom preferences for the selected platform/day
  - [ ] If custom preferences exist, use them as primary recommendations
  - [ ] Assign high engagement score (e.g., 95) to custom preferences to prioritize them
  - [ ] Mark custom preferences with `source: "user preference"` for UI display
  - [ ] If no custom preferences, fall back to research-based recommendations
  - [ ] Allow mixing: custom preferences fill top slots, research-based fill remaining slots if < 3 custom

- [ ] Task 5: Create "Posting Preferences" settings page UI (AC: 1, 6)
  - [ ] Create new page `app/settings/preferences/page.tsx`
  - [ ] Add route protection via Clerk middleware (authenticated users only)
  - [ ] Display header: "Posting Preferences"
  - [ ] Add tabs or sections for Twitter and LinkedIn preferences
  - [ ] Use shadcn/ui components for consistent UI (Card, Table, Button)
  - [ ] Show "Default Recommendations" section with research-based best practices (read-only)
  - [ ] Show "Your Custom Preferences" section with user's saved preferences (editable)

- [ ] Task 6: Implement preference creation/editing UI (AC: 2)
  - [ ] Add "Add Preference" button that opens a modal/form
  - [ ] Form fields: Platform dropdown (Twitter/LinkedIn), Day of week selector, Start time picker, End time picker
  - [ ] Use time pickers compatible with user's timezone (detect and display current timezone)
  - [ ] Allow multiple time windows per day (e.g., "Mon: 7-9am and 5-7pm")
  - [ ] Display preview of selected preferences before saving
  - [ ] On save, call `setUserPreference` mutation via Convex
  - [ ] Show success message after saving

- [ ] Task 7: Implement preference deletion and reset functionality (AC: 5)
  - [ ] Add "Delete" button next to each custom preference in the list
  - [ ] Implement delete confirmation dialog ("Are you sure?")
  - [ ] Call `deleteUserPreference` mutation on confirm
  - [ ] Add "Reset to Defaults" button at page level
  - [ ] Implement reset confirmation dialog ("This will delete all custom preferences")
  - [ ] Call `resetAllPreferences` mutation on confirm
  - [ ] Show success message after reset

- [ ] Task 8: Display side-by-side comparison of custom vs default (AC: 6)
  - [ ] Create two-column layout (or accordion on mobile)
  - [ ] Left column: "Default Recommendations" (research-based best practices)
  - [ ] Right column: "Your Custom Preferences" (user's saved preferences)
  - [ ] Use visual indicators to show differences (e.g., highlight overridden defaults)
  - [ ] Show empty state in custom column if no preferences set
  - [ ] Add helper text: "Custom preferences will override defaults in the scheduler"

- [ ] Task 9: Ensure immediate UI update in scheduler picker (AC: 7)
  - [ ] Verify that `getRecommendedTimes` query reactively updates when preferences change
  - [ ] Test: Add preference → See recommendation update in scheduler without page reload
  - [ ] Convex's realtime sync should handle this automatically via `useQuery`
  - [ ] Add visual feedback (e.g., toast notification) when preferences are applied
  - [ ] Test that deleted preferences immediately revert to default recommendations

- [ ] Task 10: Write unit tests for preference logic (AC: 2-5)
  - [ ] Test `user_preferences` schema validation
  - [ ] Test `setUserPreference` mutation with valid data
  - [ ] Test validation errors for invalid time ranges (startHour > endHour, out of 0-23 range)
  - [ ] Test `deleteUserPreference` removes correct preference
  - [ ] Test `resetAllPreferences` clears all user preferences
  - [ ] Test `getUserPreferences` query returns correct user-scoped data

- [ ] Task 11: Write integration tests for recommendation algorithm (AC: 4, 7)
  - [ ] Test recommendation prioritization with custom preferences
  - [ ] Test fallback to research-based when no custom preferences exist
  - [ ] Test mixing custom and research-based recommendations (if < 3 custom)
  - [ ] Test realtime update when preference is added/deleted
  - [ ] Test authentication checks in all mutations/queries

- [ ] Task 12: Write UI tests for settings page (AC: 1, 2, 6)
  - [ ] Test settings page renders with default and custom sections
  - [ ] Test "Add Preference" form submission creates new preference
  - [ ] Test "Delete" button removes preference from UI
  - [ ] Test "Reset to Defaults" clears all custom preferences
  - [ ] Test side-by-side comparison display
  - [ ] Test responsive layout on mobile vs desktop

## Dev Notes

### Previous Story Insights

[Source: Story 6.1, Story 6.2, Story 6.3]
- The `posting_time_recommendations` table contains research-based best practices (UTC storage)
- The `getRecommendedTimes` query returns top 3 suggestions sorted by engagement score
- The scheduler picker UI displays recommendations with auto-fill functionality
- Recommendations currently only use research-based data (no user customization yet)
- This story adds user-specific preference overrides that take priority over research data

### Data Models

**Existing Tables:** [Source: docs/architecture/data-models.md, Story 6.1]

1. **`posts`**
   - Fields: `clerkUserId`, `status`, etc.
   - Index: `by_user` on `["clerkUserId"]`

2. **`posting_time_recommendations`** [Source: Story 6.1]
   - Fields: `platform`, `dayOfWeek`, `hourRanges`, `engagementScore`, `source`
   - Index: `by_platform_day` on `["platform", "dayOfWeek"]`
   - Times stored in UTC
   - Contains research-based best practices

**New Table: `user_preferences`**

This story introduces a new table for storing user-specific posting preferences:

**Required Fields:**
- `clerkUserId`: string - Clerk user ID (for data scoping)
- `platform`: string - "twitter" or "linkedin"
- `dayOfWeek`: number - 0 (Sunday) through 6 (Saturday)
- `customTimeRanges`: array of objects - `[{ startHour: number, endHour: number }]`
- Note: Unlike `posting_time_recommendations`, times are stored in user's **local timezone** for easier editing

**Index Requirements:**
- `by_user_platform` on `["clerkUserId", "platform"]` - Lookup all preferences for a user/platform
- `by_user_platform_day` on `["clerkUserId", "platform", "dayOfWeek"]` - Lookup day-specific preferences

**Example Data Structure:**
```typescript
{
  clerkUserId: "user_abc123",
  platform: "twitter",
  dayOfWeek: 1, // Monday
  customTimeRanges: [
    { startHour: 7, endHour: 9 },   // 7-9 AM
    { startHour: 17, endHour: 19 }  // 5-7 PM
  ]
}
```

**Timezone Consideration:**
- `posting_time_recommendations` stores times in UTC (global data)
- `user_preferences` stores times in user's local timezone (personal data)
- When comparing/merging, convert user preferences to UTC for consistent comparison

### Schema Implementation Guidance

[Source: CLAUDE.md, docs/architecture/data-models.md]

**Convex Schema Pattern:**
```typescript
import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

export default defineSchema({
  // ... existing tables ...
  user_preferences: defineTable({
    clerkUserId: v.string(),
    platform: v.string(),
    dayOfWeek: v.number(),
    customTimeRanges: v.array(
      v.object({
        startHour: v.number(),
        endHour: v.number(),
      })
    ),
  })
    .index("by_user_platform", ["clerkUserId", "platform"])
    .index("by_user_platform_day", ["clerkUserId", "platform", "dayOfWeek"]),
});
```

### Mutation Implementation Guidance

[Source: CLAUDE.md - Critical Architectural Patterns]

**Authentication in Mutations:**
```typescript
const identity = await ctx.auth.getUserIdentity();
if (!identity) throw new Error("Not authenticated");
const clerkUserId = identity.subject;
```

**Mutation Pattern:**
```typescript
import { mutation } from "./_generated/server";
import { v } from "convex/values";

export const setUserPreference = mutation({
  args: {
    platform: v.string(),
    dayOfWeek: v.number(),
    customTimeRanges: v.array(
      v.object({
        startHour: v.number(),
        endHour: v.number(),
      })
    ),
  },
  returns: v.id("user_preferences"),
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Not authenticated");

    // Validation
    if (args.dayOfWeek < 0 || args.dayOfWeek > 6) {
      throw new Error("Invalid day of week");
    }

    // Check for existing preference
    const existing = await ctx.db
      .query("user_preferences")
      .withIndex("by_user_platform_day", (q) =>
        q.eq("clerkUserId", identity.subject)
         .eq("platform", args.platform)
         .eq("dayOfWeek", args.dayOfWeek)
      )
      .first();

    if (existing) {
      // Update existing
      await ctx.db.patch(existing._id, {
        customTimeRanges: args.customTimeRanges,
      });
      return existing._id;
    } else {
      // Create new
      return await ctx.db.insert("user_preferences", {
        clerkUserId: identity.subject,
        platform: args.platform,
        dayOfWeek: args.dayOfWeek,
        customTimeRanges: args.customTimeRanges,
      });
    }
  },
});
```

### Recommendation Algorithm Enhancement

[Source: Story 6.2, AC: 4]

**Priority Logic:**
1. Query `user_preferences` for the selected platform/day
2. If custom preferences exist, use them as top recommendations
3. Assign high engagement score (95) to indicate priority
4. Mark with `source: "user preference"`
5. If fewer than 3 custom preferences, fill remaining slots with research-based recommendations

**Modified Query Logic:**
```typescript
export const getRecommendedTimes = query({
  // ... existing args ...
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Not authenticated");

    // 1. Check for user preferences first
    const userPrefs = await ctx.db
      .query("user_preferences")
      .withIndex("by_user_platform_day", (q) =>
        q.eq("clerkUserId", identity.subject)
         .eq("platform", args.platform)
         .eq("dayOfWeek", dayOfWeek)
      )
      .collect();

    let recommendations = [];

    // 2. Add custom preferences as top recommendations
    if (userPrefs.length > 0) {
      recommendations.push(...userPrefs.map(pref => ({
        timeRange: formatTimeRange(pref.customTimeRanges[0]), // Convert to display format
        engagementScore: 95, // High score to prioritize
        source: "user preference",
        conflictsWithPost: false, // Check conflicts here
      })));
    }

    // 3. If < 3 recommendations, fill with research-based
    if (recommendations.length < 3) {
      const researchRecs = await ctx.db
        .query("posting_time_recommendations")
        .withIndex("by_platform_day", (q) =>
          q.eq("platform", args.platform).eq("dayOfWeek", dayOfWeek)
        )
        .collect();

      // Add research-based to fill remaining slots
      const remaining = 3 - recommendations.length;
      recommendations.push(...researchRecs.slice(0, remaining));
    }

    return recommendations.slice(0, 3); // Always return top 3
  },
});
```

### Timezone Handling

**User Timezone Detection:** [Source: Story 6.2, Story 6.3]
```typescript
const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
// Returns IANA timezone like "America/New_York"
```

**Storage Strategy:**
- `user_preferences`: Store times in user's local timezone (easier for editing)
- `posting_time_recommendations`: Store times in UTC (global data)
- Convert between timezones when comparing or merging recommendations

**Conversion Example:**
```typescript
// User preference: 7:00 AM EST (user's timezone)
// Convert to UTC for comparison: 12:00 PM UTC (EST = UTC-5)
```

### UI Component Architecture

[Source: docs/architecture/frontend-architecture.md]

**New Page Location:**
- `app/settings/preferences/page.tsx` - Settings page for preferences

**Component Breakdown:**
- `components/features/PreferenceSettings.tsx` - Main settings component
- `components/features/PreferenceForm.tsx` - Form for adding/editing preferences
- `components/features/PreferenceList.tsx` - List of saved preferences
- `components/ui/*` - Use shadcn/ui components (Card, Button, Dialog, TimePicker, etc.)

**State Management:** [Source: docs/architecture/frontend-architecture.md]
- Use Convex `useQuery` for fetching preferences (global/server state)
- Use Convex `useMutation` for creating/updating/deleting preferences
- Use React `useState` for local form state (time inputs, modal visibility)

### Convex Mutation Usage in UI

[Source: CLAUDE.md]

**Import Pattern:**
```typescript
import { useMutation, useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";
```

**Mutation Usage:**
```typescript
const setPreference = useMutation(api.userPreferences.setUserPreference);

const handleSave = async () => {
  try {
    await setPreference({
      platform: selectedPlatform,
      dayOfWeek: selectedDay,
      customTimeRanges: [{ startHour: 7, endHour: 9 }],
    });
    // Show success message
  } catch (error) {
    // Show error message
  }
};
```

### Navigation Integration

**Add Settings Link:**
- Update main navigation to include "Settings" or "Preferences" link
- Route: `/settings/preferences`
- Protect route with Clerk middleware (authenticated users only)

**Navigation Location:**
Based on standard Next.js App Router patterns, navigation is likely in:
- `app/layout.tsx` - Global navigation
- Or `components/features/Navigation.tsx` - Separate navigation component

### Side-by-Side Comparison UI

**Layout Pattern (AC: 6):**
```tsx
<div className="grid grid-cols-1 md:grid-cols-2 gap-6">
  <Card>
    <CardHeader>Default Recommendations</CardHeader>
    <CardContent>
      {/* Display research-based best practices (read-only) */}
    </CardContent>
  </Card>

  <Card>
    <CardHeader>Your Custom Preferences</CardHeader>
    <CardContent>
      {/* Display user's saved preferences (editable) */}
    </CardContent>
  </Card>
</div>
```

**Mobile-Responsive:** [Source: CLAUDE.md]
- Stack columns vertically on mobile (`grid-cols-1`)
- Side-by-side on desktop (`md:grid-cols-2`)

### Time Picker Component

**Options:**
- Use shadcn/ui's DatePicker component (if available)
- Or use a time input with hour/minute dropdowns
- Or use a third-party time picker library (e.g., `react-time-picker`)

**Requirements:**
- Support 12-hour or 24-hour format (user preference)
- Display user's current timezone
- Validate time ranges (start < end)

### Realtime Updates (AC: 7)

[Source: docs/architecture/frontend-architecture.md, CLAUDE.md]

**Convex Realtime Sync:**
- Convex `useQuery` hooks automatically re-run when data changes
- When user saves a preference, `user_preferences` table updates
- `getRecommendedTimes` query reactively updates (if it depends on preferences)
- Scheduler picker UI re-renders with new recommendations automatically

**No manual polling or refresh needed!**

### File Locations

**New Files:**
- `convex/userPreferences.ts` - Mutations and queries for preference management
- `app/settings/preferences/page.tsx` - Settings page for preferences UI
- `components/features/PreferenceSettings.tsx` - Main settings component
- `components/features/PreferenceForm.tsx` - Form for adding/editing preferences
- `components/features/PreferenceList.tsx` - List of saved preferences (optional)

**Modified Files:**
- `convex/schema.ts` - Add `user_preferences` table
- `convex/recommendations.ts` - Enhance `getRecommendedTimes` to prioritize user preferences
- Navigation component - Add link to preferences settings page

**Existing Files:**
- `components/ui/*` - Use existing shadcn/ui components

### Testing

[Source: docs/architecture/testing-strategy.md]

**Unit Testing Focus:**
- Schema validation for `user_preferences` table
- Mutation validation logic (time range, day of week)
- Preference prioritization logic in recommendation algorithm
- Timezone conversion accuracy

**Integration Testing Focus:**
- Full flow: Create preference → See in settings → See in scheduler recommendations
- Realtime update verification (add/delete preference updates recommendations)
- Authentication checks in all mutations/queries
- Index performance on `by_user_platform_day`

**UI Testing Focus:**
- Settings page rendering
- Form submission and validation
- Delete and reset functionality
- Side-by-side comparison display
- Responsive layout on mobile vs desktop

**Test Tools:**
- Jest for unit tests
- React Testing Library for component tests
- Convex testing utilities for database operations

### Technical Constraints

**Authentication:** [Source: docs/architecture/security.md]
- All mutations/queries must verify user authentication
- Users can only access/modify their own preferences (scoped by `clerkUserId`)

**Data Scoping:** [Source: CLAUDE.md, docs/architecture/security.md]
- All user preferences must be scoped to `clerkUserId`
- Never show one user's preferences to another user

**Performance:**
- Use indexes for efficient lookups (`by_user_platform_day`)
- Limit number of custom preferences per user (optional: max 20 per platform)

**Validation:**
- Ensure `startHour < endHour` within same time range
- Ensure `startHour` and `endHour` are within 0-23 range
- Ensure `dayOfWeek` is within 0-6 range
- Prevent overlapping time ranges (optional enhancement)

### User Experience Considerations

**Empty State:**
- When no custom preferences are set, show helpful message: "No custom preferences yet. Add your first preference to override default recommendations."
- Include "Add Preference" button prominently

**Success Feedback:**
- Show toast notification when preference is saved: "Preference saved! Your scheduler will now prioritize this time."
- Show toast when preference is deleted: "Preference removed. Reverting to default recommendations."

**Conflict Warnings:**
- If user sets a preference that conflicts with their scheduled posts, show warning (optional)
- Help users choose optimal times based on their actual posting habits

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-03 | 1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_To be filled by QA agent_
