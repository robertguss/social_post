# Story 2.3: Dual Platform Post Creation Form

## Status

Ready

## Story

**As a** content creator,
**I want** to create posts for both X/Twitter and LinkedIn with separate content and staggered scheduling times,
**so that** I can optimize content for each platform.

## Acceptance Criteria

1. The post creation form includes separate text fields for X/Twitter content (280 char max) and LinkedIn content (3,000 char max).
2. Each text field has its own character counter with appropriate visual warnings.
3. A single URL field is provided that can be used for both platforms (threaded reply on X, first comment on LinkedIn).
4. Separate date/time selectors are provided for X/Twitter and LinkedIn to support staggered posting.
5. Users can optionally post to both platforms, X only, or LinkedIn only (via checkboxes or toggle).
6. On submission, a `posts` record is created with both `twitterContent`/`twitterScheduledTime` and `linkedInContent`/`linkedInScheduledTime` fields populated as applicable.

## Tasks / Subtasks

- [ ] **Task 1: Update PostScheduler Component UI Structure** (AC: 1, 2, 5)
  - [ ] Modify `components/features/PostScheduler.tsx` to support dual-platform layout
  - [ ] Add platform selection UI (checkboxes or toggles for Twitter and LinkedIn)
  - [ ] Reorganize layout to accommodate two content fields and two date/time pickers
  - [ ] Add conditional rendering logic to show/hide fields based on platform selection
  - [ ] Ensure mobile-responsive design for expanded form layout

- [ ] **Task 2: Implement LinkedIn Content Field with Character Counter** (AC: 1, 2)
  - [ ] Add state management for `linkedInContent` string
  - [ ] Add shadcn/ui Textarea component for LinkedIn content
  - [ ] Implement character counting logic for LinkedIn (3,000 char max)
  - [ ] Display character count: `{currentLength}/3,000`
  - [ ] Add visual warning styles when count reaches 2,900 (yellow/orange text)
  - [ ] Add error state and disable submit when count exceeds 3,000
  - [ ] Test character counter with various input scenarios

- [ ] **Task 3: Update Twitter Content Field Label and Context** (AC: 1, 2)
  - [ ] Update existing Twitter content field label to clarify platform
  - [ ] Maintain existing character counter logic (280 max, warning at 260)
  - [ ] Ensure visual consistency with LinkedIn field styling
  - [ ] Update accessibility attributes for dual-platform context

- [ ] **Task 4: Update URL Field Helper Text for Dual Platform** (AC: 3)
  - [ ] Update helper text to explain URL behavior on both platforms
  - [ ] Text should read: "URL will be posted as a reply on X/Twitter and as the first comment on LinkedIn"
  - [ ] Maintain existing optional validation

- [ ] **Task 5: Add LinkedIn Date/Time Selector** (AC: 4)
  - [ ] Add state management for `linkedInScheduledTime` Date object
  - [ ] Add second DateTimePicker component for LinkedIn scheduling
  - [ ] Configure to use local timezone (same as Twitter picker)
  - [ ] Set minimum date/time to current time
  - [ ] Display selected date/time in readable format
  - [ ] Add conditional rendering based on LinkedIn platform selection

- [ ] **Task 6: Update Form State Management** (AC: 5, 6)
  - [ ] Add state for platform selection: `enableTwitter` and `enableLinkedIn` booleans
  - [ ] Update form validation to require at least one platform selected
  - [ ] Add validation to require content if platform is enabled
  - [ ] Add validation to require scheduled time if platform is enabled
  - [ ] Update form submission logic to handle both platforms

- [ ] **Task 7: Update Convex Mutation for Dual Platform Posts** (AC: 6)
  - [ ] Modify `createPost` mutation in `convex/posts.ts` to accept dual-platform args
  - [ ] Update args validators to support optional `twitterContent`, `linkedInContent`, `twitterScheduledTime`, `linkedInScheduledTime`
  - [ ] Add validation to require at least one platform's content and time
  - [ ] Update mutation logic to populate both platform fields in database record
  - [ ] Maintain backward compatibility with Twitter-only posts (if needed)
  - [ ] Update scheduling logic to handle both platforms (schedule separate actions if both platforms selected)

- [ ] **Task 8: Update Form Submission Handler** (AC: 6)
  - [ ] Modify `handleSubmit` function to build mutation args based on platform selection
  - [ ] Convert both date/time values to UTC timestamps
  - [ ] Only include Twitter fields if `enableTwitter` is true
  - [ ] Only include LinkedIn fields if `enableLinkedIn` is true
  - [ ] Update success message to reflect which platforms were scheduled
  - [ ] Clear all form fields on successful submission

- [ ] **Task 9: Unit Testing for Dual Platform Character Counters** (AC: 1, 2)
  - [ ] Update `__tests__/components/PostScheduler.test.tsx`
  - [ ] Test LinkedIn character counter updates correctly
  - [ ] Test LinkedIn warning state at 2,900 characters
  - [ ] Test LinkedIn error state at 3,000+ characters
  - [ ] Test submit button disabled when LinkedIn limit exceeded
  - [ ] Test both counters work independently
  - [ ] Ensure all existing Twitter tests still pass

- [ ] **Task 10: Integration Testing for Dual Platform Post Creation** (AC: 6)
  - [ ] Update `__tests__/convex/posts.test.ts`
  - [ ] Test `createPost` mutation with Twitter-only post
  - [ ] Test `createPost` mutation with LinkedIn-only post
  - [ ] Test `createPost` mutation with both platforms (dual-platform post)
  - [ ] Test validation requires at least one platform
  - [ ] Test validation requires content for selected platforms
  - [ ] Test validation requires scheduled time for selected platforms
  - [ ] Test both platform fields populated correctly in database
  - [ ] Ensure all existing tests still pass

- [ ] **Task 11: UI/UX Testing for Platform Selection** (AC: 5)
  - [ ] Test platform checkboxes/toggles work correctly
  - [ ] Test conditional field visibility based on platform selection
  - [ ] Test form validation messages for each platform combination
  - [ ] Test mobile responsiveness of expanded form layout
  - [ ] Test accessibility (keyboard navigation, screen readers)

## Dev Notes

### Architecture Context

This story extends the existing Post Creation Form from Story 1.4 to support dual-platform scheduling. The core workflow remains the same, but the form now accommodates separate content and scheduling for both X/Twitter and LinkedIn, enabling the user's preferred workflow of writing Twitter content first (280 char limit) then expanding for LinkedIn.

[Source: docs/prd/1-goals-and-background-context.md#user-workflow]
[Source: CLAUDE.md#important-notes]

### Previous Story Insights

**From Story 1.4 (Post Creation Form - X Focus):**

- Post creation form implemented in `components/features/PostScheduler.tsx`
- Character counter logic working with visual warnings (260 yellow, 280 red)
- Date/time picker using shadcn/ui DateTimePicker component
- Form submission integrated with Convex `createPost` mutation
- State managed with React `useState` hooks
- Form validation working for content, character limit, and scheduled time

[Source: docs/stories/1.4.post-creation-form-x-focus.md#completion-notes]

**From Story 2.1 (LinkedIn OAuth Integration):**

- LinkedIn connection status available in ConnectionManager component
- LinkedIn OAuth fully functional and storing encrypted tokens
- Users can connect both Twitter and LinkedIn accounts

[Source: docs/stories/2.1.secure-linkedin-oauth-integration.md#completion-notes]

**From Story 2.2 (LinkedIn Token Encryption):**

- LinkedIn tokens encrypted using same infrastructure as Twitter
- Token refresh logic implemented for LinkedIn
- Both platforms use same security patterns

[Source: docs/stories/2.2.linkedin-token-encryption-storage.md#completion-notes]

### Data Models

**posts Table:**

Current schema supports dual-platform posts. The following fields will be used:

- `clerkUserId`: string (Clerk user ID - automatically set from authenticated user)
- `status`: string (set to "Scheduled" on form submission)
- `twitterContent`: string (optional - populated if Twitter platform selected)
- `linkedInContent`: string (optional - populated if LinkedIn platform selected)
- `twitterScheduledTime`: number (optional - UTC timestamp if Twitter selected)
- `linkedInScheduledTime`: number (optional - UTC timestamp if LinkedIn selected)
- `url`: string (optional - single URL for both platforms)

**Important:** At least one platform must be selected, meaning either `twitterContent`/`twitterScheduledTime` OR `linkedInContent`/`linkedInScheduledTime` (or both) must be populated.

**Index:** `by_user` on `["clerkUserId"]` - enables fast lookup of all posts for authenticated user

[Source: docs/architecture/data-models.md]
[Source: convex/schema.ts:12-24]

### Frontend Architecture Details

#### Component Architecture

**Component to Modify:** `components/features/PostScheduler.tsx` (Core Feature component)

**New Responsibilities:**

1. Platform selection UI (checkboxes/toggles for Twitter and LinkedIn)
2. Conditional rendering of platform-specific fields
3. Two separate character counters (280 for Twitter, 3,000 for LinkedIn)
4. Two separate date/time pickers (staggered scheduling)
5. Dual-platform validation logic
6. Updated Convex mutation call with dual-platform args

**State Management Changes:**

- Add `enableTwitter`: boolean (default: true for backward compatibility)
- Add `enableLinkedIn`: boolean (default: false)
- Add `linkedInContent`: string
- Add `linkedInScheduledTime`: Date | undefined
- Existing: `content` → rename or repurpose as `twitterContent`
- Existing: `scheduledTime` → rename or repurpose as `twitterScheduledTime`
- Existing: `url`, `isSubmitting`, `error`, `success`

[Source: docs/architecture/frontend-architecture.md#component-architecture]

#### UI Component Library

**Existing shadcn/ui Components (Already Installed):**

- Textarea (for content fields)
- Input (for URL field)
- Button (for submit)
- Label (for field labels)
- Card (for form container)
- DateTimePicker (for scheduling)

**New Components Needed:**

- Checkbox or Switch component for platform selection (need to add via shadcn CLI)

**Installation Command (if Checkbox not installed):**

```bash
npx shadcn@latest add checkbox
# OR
npx shadcn@latest add switch
```

[Source: docs/stories/1.4.post-creation-form-x-focus.md#ui-component-library-shadcnui]

### Character Limit Specifications

**X/Twitter:**

- Maximum: 280 characters
- Warning threshold: 260 characters (yellow/orange text)
- Error: Over 280 characters (red text, disable submit)

**LinkedIn:**

- Maximum: 3,000 characters
- Warning threshold: 2,900 characters (yellow/orange text)
- Error: Over 3,000 characters (red text, disable submit)

[Source: CLAUDE.md#character-counting]

### Convex Mutation Updates

**Current Signature:**

```typescript
export const createPost = mutation({
  args: {
    content: v.string(),
    url: v.optional(v.string()),
    scheduledTime: v.number(),
  },
  // ...
});
```

**New Signature (Backward Compatible Approach):**

```typescript
export const createPost = mutation({
  args: {
    // Platform-specific fields
    twitterContent: v.optional(v.string()),
    linkedInContent: v.optional(v.string()),
    twitterScheduledTime: v.optional(v.number()),
    linkedInScheduledTime: v.optional(v.number()),
    // Shared field
    url: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    // Validation: At least one platform must be selected
    const hasTwitter = args.twitterContent && args.twitterScheduledTime;
    const hasLinkedIn = args.linkedInContent && args.linkedInScheduledTime;

    if (!hasTwitter && !hasLinkedIn) {
      throw new Error("At least one platform must be selected");
    }

    // Character validation
    if (hasTwitter && args.twitterContent!.length > 280) {
      throw new Error("Twitter content exceeds 280 character limit");
    }

    if (hasLinkedIn && args.linkedInContent!.length > 3000) {
      throw new Error("LinkedIn content exceeds 3,000 character limit");
    }

    // Schedule separate publishing actions for each platform
    // Twitter: ctx.scheduler.runAt(args.twitterScheduledTime, internal.publishing.publishTwitterPost, { postId })
    // LinkedIn: ctx.scheduler.runAt(args.linkedInScheduledTime, internal.publishing.publishLinkedInPost, { postId })
  },
});
```

**Scheduling Logic:**

- If both platforms selected: Schedule TWO separate Convex Actions (one for Twitter, one for LinkedIn)
- If Twitter only: Schedule `internal.publishing.publishTwitterPost` action
- If LinkedIn only: Schedule `internal.publishing.publishLinkedInPost` action (to be implemented in Story 2.4)

[Source: convex/posts.ts:17-83]
[Source: CLAUDE.md#scheduling-posts-critical-pattern]

### File Locations

**Files to Modify:**

- `components/features/PostScheduler.tsx` - Main form component (major refactor)
- `convex/posts.ts` - Update `createPost` mutation args and logic
- `__tests__/components/PostScheduler.test.tsx` - Update unit tests
- `__tests__/convex/posts.test.ts` - Update integration tests

**Files to Review (No Changes Expected):**

- `convex/schema.ts` - Schema already supports dual-platform (no changes needed)
- `app/schedule/page.tsx` - Route page (no changes needed)

[Source: docs/architecture/high-level-architecture.md#repository-structure]

### UI/UX Design Considerations

**Platform Selection UI Options:**

**Option A: Checkboxes (Recommended)**

- Two checkboxes: "Post to X/Twitter" and "Post to LinkedIn"
- Default: Twitter checked, LinkedIn unchecked
- At least one must be checked (validation)
- Simple, clear, accessible

**Option B: Toggle Switches**

- Two switch components for each platform
- More modern UI feel
- Same functionality as checkboxes

**Recommendation:** Use checkboxes for clarity and accessibility. More intuitive for "select one or more" scenarios.

**Form Layout:**

- Platform selection at top of form
- Conditionally show Twitter fields only if Twitter checkbox checked
- Conditionally show LinkedIn fields only if LinkedIn checkbox checked
- URL field always visible (shared by both platforms)
- Submit button at bottom

**Mobile Responsiveness:**

- Form should stack vertically on mobile
- Each platform's fields should be visually grouped
- Character counters should be visible without scrolling

[Source: CLAUDE.md#important-notes - mobile-responsive design required]

### Validation Rules

**Platform Selection:**

- At least one platform must be selected (Twitter OR LinkedIn OR both)
- Error message: "Please select at least one platform"

**Twitter Validation (if Twitter selected):**

- Content required: `twitterContent.trim() !== ""`
- Character limit: `twitterContent.length <= 280`
- Scheduled time required: `twitterScheduledTime !== undefined`
- Scheduled time must be in future: `twitterScheduledTime > Date.now()`

**LinkedIn Validation (if LinkedIn selected):**

- Content required: `linkedInContent.trim() !== ""`
- Character limit: `linkedInContent.length <= 3000`
- Scheduled time required: `linkedInScheduledTime !== undefined`
- Scheduled time must be in future: `linkedInScheduledTime > Date.now()`

**URL Validation (optional):**

- If provided, should be valid URL format
- Same validation as Story 1.4

### Tech Stack Requirements

**Frontend:**

- Next.js 15.5.4 with App Router
- React 19
- TypeScript ^5 with strict type checking
- shadcn/ui components
- Tailwind CSS ^4 for styling

**Backend:**

- Convex ^1.28.0 for mutations and scheduling
- Convex function syntax with args/returns validators
- TypeScript for type safety

[Source: docs/architecture/tech-stack.md]

### Testing Requirements

**Test Framework:** Jest for unit and integration tests

**Test File Locations:**

- Unit tests: `__tests__/components/PostScheduler.test.tsx`
- Integration tests: `__tests__/convex/posts.test.ts`

**Unit Tests (Character Counter Logic):**

- Twitter counter updates correctly (existing test - maintain)
- LinkedIn counter updates correctly (new test)
- Twitter warning at 260 chars (existing - maintain)
- LinkedIn warning at 2,900 chars (new test)
- Twitter error at 280+ chars (existing - maintain)
- LinkedIn error at 3,000+ chars (new test)
- Submit disabled when either counter over limit (new test)
- Both counters work independently (new test)

**Integration Tests (Post Creation Flow):**

- Twitter-only post creates successfully (update existing test)
- LinkedIn-only post creates successfully (new test)
- Dual-platform post creates successfully (new test)
- Validation requires at least one platform (new test)
- Validation checks content for selected platforms (new test)
- Validation checks scheduled time for selected platforms (new test)
- Database record populated correctly for Twitter-only (update existing)
- Database record populated correctly for LinkedIn-only (new test)
- Database record populated correctly for both platforms (new test)

**UI/UX Tests:**

- Platform checkboxes toggle field visibility (new test)
- Form validation messages display correctly (new test)
- Mobile layout renders correctly (manual test)
- Accessibility: keyboard navigation works (manual test)

**Test Coverage Goal:**

- Maintain 100% test pass rate
- Add comprehensive tests for all new dual-platform functionality
- Follow existing test patterns from Story 1.4

[Source: docs/architecture/testing-strategy.md]
[Source: docs/stories/1.4.post-creation-form-x-focus.md#testing-requirements]

### Security Requirements

**Authentication:**

- Verify user with `ctx.auth.getUserIdentity()` in mutation
- All data scoped to authenticated user's `clerkUserId`
- Route protected by Clerk middleware (already configured)

**Input Validation:**

- Sanitize and validate all user inputs
- Enforce character limits on backend (not just frontend)
- Validate scheduled times are in future
- Validate URL format if provided

**Best Practices:**

- No sensitive data in client-side logs
- Proper error handling with user-friendly messages
- TypeScript strict mode for type safety

[Source: docs/architecture/security.md#authentication-authorization]
[Source: CLAUDE.md#authentication-flow]

### Project Structure Notes

**Structure Alignment:** All file paths align with established project structure. No conflicts found.

**Existing Infrastructure:**

- PostScheduler component exists and is working (Story 1.4)
- Character counter logic pattern established
- DateTimePicker component installed and working
- Convex mutation pattern established
- Test infrastructure set up with Jest

**Pattern Consistency:**

- Follow Story 1.4 form patterns (state management, validation, submission)
- Maintain consistent character counter styling and behavior
- Use same error handling patterns
- Follow same test structure as Story 1.4

**Backward Compatibility Considerations:**

- Existing Twitter-only posts should continue to work
- Mutation should support both old and new calling patterns (if needed)
- Existing tests should still pass after changes

### User Workflow Optimization

**Key User Flow:**

1. User selects which platform(s) to post to (checkboxes)
2. User writes Twitter content first (280 char limit enforces brevity)
3. User expands content for LinkedIn (3,000 char limit)
4. User sets staggered posting times (e.g., Twitter at 9am, LinkedIn at 10am)
5. User adds optional URL (will be posted to both platforms)
6. User submits form → both posts scheduled

**Design Goals:**

- Fast and simple workflow (productivity tool)
- Clear visual separation between platforms
- Real-time character counting for immediate feedback
- Mobile-responsive for on-the-go scheduling

[Source: CLAUDE.md#important-notes]
[Source: docs/prd/3-user-interface-design-goals.md]

## Change Log

| Date       | Version | Description                 | Author       |
| ---------- | ------- | --------------------------- | ------------ |
| 2025-10-31 | 1.0     | Initial story draft created | Scrum Master |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_This section will be populated by the QA agent during review._
