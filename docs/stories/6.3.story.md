# Story 6.3: Suggestion UI in Scheduler Picker

## Status
Draft

## Story
**As a** content creator,
**I want** to see recommended posting times when scheduling content,
**so that** I can choose optimal times without researching best practices myself.

## Acceptance Criteria

1. The date/time picker in the post creation form displays a "Recommended Times" section.
2. When the user selects a date, the "Recommended Times" section shows 3 suggested time slots for each enabled platform.
3. Each suggestion displays: time (in user's timezone), platform icon, and a brief reason (e.g., "High engagement window").
4. Clicking a suggested time auto-fills the corresponding platform's scheduled time field.
5. Recommendations update dynamically when the user changes the selected date or toggles platform selection.
6. If the user manually enters a time, suggestions remain visible but are not automatically applied.
7. A small info icon/tooltip explains the source of recommendations (e.g., "Based on industry research").

## Tasks / Subtasks

- [ ] Task 1: Add "Recommended Times" section to post composer UI (AC: 1)
  - [ ] Identify the post creation form component (likely in `components/features/`)
  - [ ] Add new UI section for "Recommended Times" below or next to date/time picker
  - [ ] Use shadcn/ui components for consistent styling (Card, Badge, etc.)
  - [ ] Add conditional rendering to show section only when date is selected
  - [ ] Ensure mobile-responsive layout (stack on mobile, side-by-side on desktop)

- [ ] Task 2: Integrate Convex query to fetch recommendations (AC: 2, 5)
  - [ ] Import `useQuery` hook from Convex
  - [ ] Call `api.recommendations.getRecommendedTimes` query with date, platform, userTimezone
  - [ ] Detect user's timezone automatically using `Intl.DateTimeFormat().resolvedOptions().timeZone`
  - [ ] Pass selected date from date picker state
  - [ ] Pass enabled platform(s) based on platform toggle state
  - [ ] Handle loading state while query executes
  - [ ] Handle error state if query fails

- [ ] Task 3: Display recommendation suggestions with platform icons (AC: 2, 3)
  - [ ] Map over query results to render suggestion cards/chips
  - [ ] Display time range in user-friendly format (e.g., "9:00 AM - 11:00 AM EST")
  - [ ] Add platform icon (Twitter/X logo or LinkedIn logo) next to each suggestion
  - [ ] Display engagement level as reason text (e.g., "High engagement window" for score > 80)
  - [ ] Use color-coding or badges to indicate engagement level (green for high, yellow for medium)
  - [ ] Show conflict warning if suggestion conflicts with existing post

- [ ] Task 4: Implement click handler to auto-fill scheduled time (AC: 4)
  - [ ] Add onClick handler to each suggestion card/chip
  - [ ] Extract start time from clicked suggestion's time range
  - [ ] Update the appropriate platform's scheduled time field state (Twitter or LinkedIn)
  - [ ] Show visual feedback when time is auto-filled (e.g., highlight the time field)
  - [ ] Scroll or focus to the updated time field for user visibility

- [ ] Task 5: Implement dynamic recommendation updates (AC: 5)
  - [ ] Add useEffect or reactive logic to watch for date picker changes
  - [ ] Add useEffect or reactive logic to watch for platform toggle changes
  - [ ] Re-fetch recommendations when date or platform selection changes
  - [ ] Show loading indicator during re-fetch
  - [ ] Clear previous suggestions during loading to avoid confusion

- [ ] Task 6: Add info tooltip explaining recommendation source (AC: 7)
  - [ ] Add info icon (ⓘ) next to "Recommended Times" heading
  - [ ] Use shadcn/ui Tooltip component for hover/click interaction
  - [ ] Display tooltip text: "Based on industry research and best practices for optimal engagement"
  - [ ] Include note about future personalization (if applicable): "In the future, we'll personalize based on your posting history"
  - [ ] Ensure tooltip is accessible (keyboard navigable, screen reader friendly)

- [ ] Task 7: Handle edge cases and empty states (AC: 6)
  - [ ] Display message if no recommendations available for selected date/platform
  - [ ] Show "No conflicts" badge if all suggestions are conflict-free
  - [ ] Keep suggestions visible when user manually enters a time (AC: 6)
  - [ ] Add visual indicator if manually entered time differs from suggestions
  - [ ] Handle case where user disables both platforms (hide recommendations)

- [ ] Task 8: Write unit tests for UI components (AC: 1-7)
  - [ ] Test "Recommended Times" section renders when date is selected
  - [ ] Test section hides when no date is selected
  - [ ] Test suggestions render correctly with mock query data
  - [ ] Test click handler auto-fills scheduled time field
  - [ ] Test tooltip displays on info icon interaction
  - [ ] Test responsive layout on mobile vs desktop viewports
  - [ ] Test loading and error states

- [ ] Task 9: Write integration tests with Convex query (AC: 2, 5)
  - [ ] Test recommendations fetch when date picker changes
  - [ ] Test recommendations update when platform toggle changes
  - [ ] Test correct timezone detection and passing to query
  - [ ] Test handling of query loading state
  - [ ] Test handling of query error state
  - [ ] Test recommendations display real data from seeded recommendations

## Dev Notes

### Previous Story Insights

[Source: Story 6.1, Story 6.2]
- The `posting_time_recommendations` table has been created and seeded with Twitter/LinkedIn best practices
- The `getRecommendedTimes` query is available in `convex/recommendations.ts`
- Query returns top 3 recommendations sorted by engagement score
- Recommendations include timezone-converted time ranges, engagement scores, and conflict detection
- Fallback logic provides default suggestions if no research-based data exists

### Component Architecture

[Source: docs/architecture/frontend-architecture.md]

**Component Locations:**
- **Pages/Views:** `app/` directory (Next.js App Router)
- **Core Features:** `components/features/` - Complex workflow components
- **UI Primitives:** `components/ui/` - shadcn/ui components
- **Convex Hooks:** `hooks/` - Custom hooks for data fetching

**Post Creation Form Location:**
Based on routing architecture, the post creation/scheduling form is likely at:
- `app/schedule/page.tsx` (Page component)
- `components/features/PostScheduler.tsx` or `PostComposer.tsx` (Feature component)

**Component to Modify:**
The "Recommended Times" section should be added to the post scheduling feature component, likely `components/features/PostScheduler.tsx` or similar.

### State Management

[Source: docs/architecture/frontend-architecture.md]

**Global State (Data):**
- Primary state driven by **Convex** via `useQuery` hooks
- Realtime data sync with Convex backend
- No additional state management library needed

**Local UI State:**
- Standard React hooks (`useState`) manage temporary UI state
- Examples: form inputs, modal visibility, tab selection

**For This Story:**
- Use `useQuery` from Convex to fetch recommendations (global/server state)
- Use `useState` for local UI state: selected date, platform toggles, auto-fill feedback

### Convex Query Integration

[Source: CLAUDE.md, Story 6.2]

**Import Pattern:**
```typescript
import { useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";
```

**Query Usage:**
```typescript
const recommendations = useQuery(
  api.recommendations.getRecommendedTimes,
  {
    date: selectedDate, // ISO string: "2025-11-15"
    platform: selectedPlatform, // "twitter" or "linkedin"
    userTimezone: Intl.DateTimeFormat().resolvedOptions().timeZone
  }
);
```

**Handling Query States:**
- `recommendations === undefined` → Loading state
- `recommendations === null` → Error or no data
- `recommendations === [...]` → Data available

### UI Component Library

[Source: docs/architecture/tech-stack.md, docs/architecture/frontend-architecture.md]

**shadcn/ui Components:**
- Location: `components/ui/`
- Use for consistent, accessible UI primitives
- Likely needed components:
  - `Card` - For recommendation section container
  - `Badge` - For engagement level indicators
  - `Tooltip` - For info icon explanations
  - `Button` or clickable card for suggestion selection

**Styling:**
- Use Tailwind CSS utility classes (already configured)
- Follow mobile-responsive design patterns
- Ensure accessibility (ARIA labels, keyboard navigation)

### Timezone Detection

**Browser API:**
```typescript
const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
// Returns IANA timezone like "America/New_York"
```

**Pass to Query:**
- Detect timezone once when component mounts
- Pass to `getRecommendedTimes` query as parameter
- Query handles timezone conversion and returns formatted times

### Platform Icons

**Asset Sources:**
- Twitter/X logo: Use SVG or icon library (e.g., `lucide-react` icons)
- LinkedIn logo: Use SVG or icon library
- Ensure logos are sized consistently and accessible

**Implementation:**
```typescript
{platform === "twitter" ? <TwitterIcon /> : <LinkedInIcon />}
```

### Engagement Level Mapping

[Source: Story 6.1, Story 6.2]
Engagement scores are normalized 0-100. Map to user-friendly text:

- **80-100:** "High engagement window" (green badge)
- **60-79:** "Good engagement window" (yellow/amber badge)
- **40-59:** "Moderate engagement" (gray badge)
- **0-39:** "Low engagement" (red badge or no badge)

### Dynamic Updates Implementation

**React Patterns:**
```typescript
useEffect(() => {
  // Re-fetch recommendations when date or platform changes
  // Convex useQuery automatically handles this if dependencies are reactive
}, [selectedDate, selectedPlatform]);
```

**Convex Auto-Reactivity:**
- Convex `useQuery` automatically re-runs when parameters change
- No manual re-fetch needed if dependencies are correctly passed
- Show loading state during re-query

### Auto-Fill Logic

**State Management:**
- Assuming form state is managed with `useState` or form library (e.g., React Hook Form)
- Identify the state setter for Twitter/LinkedIn scheduled time fields

**Implementation:**
```typescript
const handleSuggestionClick = (suggestion, platform) => {
  const startTime = extractStartTime(suggestion.timeRange);
  if (platform === "twitter") {
    setTwitterScheduledTime(startTime);
  } else {
    setLinkedInScheduledTime(startTime);
  }
};
```

**Time Extraction:**
- Parse suggestion's time range string (e.g., "9:00 AM - 11:00 AM EST")
- Extract start time (9:00 AM)
- Convert to format expected by date/time picker (likely Date object or timestamp)

### File Locations

**Files to Modify:**
- `components/features/PostScheduler.tsx` (or similar) - Add "Recommended Times" section
- `app/schedule/page.tsx` (if rendering inline) - Or page component that contains the form

**New Files (if needed):**
- `components/features/RecommendedTimes.tsx` - Extract as separate component if logic is complex
- `hooks/useRecommendations.ts` - Custom hook for fetching and managing recommendation state (optional)

**Existing Files:**
- `convex/recommendations.ts` - Query already implemented in Story 6.2
- `components/ui/*` - Use existing shadcn/ui components

### Path Alias

[Source: CLAUDE.md]
The project uses `@/*` for imports from the root directory (configured in `tsconfig.json`).

**Import Examples:**
```typescript
import { api } from "@/convex/_generated/api";
import { Card } from "@/components/ui/card";
import { useQuery } from "convex/react";
```

### Testing

[Source: docs/architecture/testing-strategy.md]

**Unit Testing Focus:**
- Component rendering with different states (loading, error, data)
- Click handler for auto-fill functionality
- Dynamic update logic when props change
- Tooltip interaction
- Responsive layout rendering

**Integration Testing Focus:**
- Real Convex query integration with `useQuery`
- Timezone detection and passing to query
- Form state updates on suggestion click
- Real recommendation data display

**Test Tools:**
- Jest for unit tests
- React Testing Library for component testing
- Mocking libraries for Convex query responses (in unit tests)

**Test File Location:**
- Co-locate with component: `components/features/__tests__/PostScheduler.test.tsx`
- Or separate test directory

### Mobile-Responsive Design

[Source: CLAUDE.md, docs/architecture/tech-stack.md]

**Key Requirement:**
- The application is mobile-responsive (user will schedule posts from mobile)
- Ensure "Recommended Times" section works well on small screens

**Implementation Tips:**
- Use Tailwind CSS responsive utilities: `flex flex-col md:flex-row`
- Stack suggestions vertically on mobile, horizontal on desktop
- Ensure touch targets are large enough for mobile (minimum 44px)
- Test on various screen sizes

### Accessibility

**Requirements:**
- Info tooltip must be keyboard accessible (focus on icon, show tooltip)
- Suggestion cards should be clickable via keyboard (Enter key)
- Add ARIA labels for screen readers (e.g., "Recommended posting time: 9:00 AM")
- Ensure color contrast meets WCAG standards

### Technical Constraints

**Authentication:** [Source: docs/architecture/security.md]
- User must be authenticated to view recommendations (Convex query checks auth)
- Component should handle unauthenticated state (redirect to login or show message)

**Performance:**
- Recommendations query is lightweight (top 3 results only)
- Use Convex realtime updates for instant data sync
- Avoid unnecessary re-renders with React.memo if needed

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-03 | 1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_To be filled by QA agent_
